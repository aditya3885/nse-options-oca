<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE OCA PRO WEB</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.43/builds/moment-timezone-with-data-2012-2022.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Option Katta</h1>

        <div class="ticker-wrap">
            <div class="ticker">
                <div class="ticker-item"><span class="ticker-symbol">NIFTY:</span><span id="ticker-nifty-value" class="ticker-value">-</span><span id="ticker-nifty-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">FINNIFTY:</span><span id="ticker-finnifty-value" class="ticker-value">-</span><span id="ticker-finnifty-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BANKNIFTY:</span><span id="ticker-banknifty-value" class="ticker-value">-</span><span id="ticker-banknifty-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SENSEX:</span><span id="ticker-sensex-value" class="ticker-value">-</span><span id="ticker-sensex-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">INDIAVIX:</span><span id="ticker-indiavix-value" class="ticker-value">-</span><span id="ticker-indiavix-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">GOLD:</span><span id="ticker-gold-value" class="ticker-value">-</span><span id="ticker-gold-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SILVER:</span><span id="ticker-silver-value" class="ticker-value">-</span><span id="ticker-silver-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BTC-USD:</span><span id="ticker-btcusd-value" class="ticker-value">-</span><span id="ticker-btcusd-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">USD-INR:</span><span id="ticker-usdinr-value" class="ticker-value">-</span><span id="ticker-usdinr-change" class="ticker-change">-</span></div>
                <!-- Cloned items -->
                <div class="ticker-item"><span class="ticker-symbol">NIFTY:</span><span id="ticker-nifty-value-clone" class="ticker-value">-</span><span id="ticker-nifty-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">FINNIFTY:</span><span id="ticker-finnifty-value-clone" class="ticker-value">-</span><span id="ticker-finnifty-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BANKNIFTY:</span><span id="ticker-banknifty-value-clone" class="ticker-value">-</span><span id="ticker-banknifty-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SENSEX:</span><span id="ticker-sensex-value-clone" class="ticker-value">-</span><span id="ticker-sensex-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">INDIAVIX:</span><span id="ticker-indiavix-value-clone" class="ticker-value">-</span><span id="ticker-indiavix-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">GOLD:</span><span id="ticker-gold-value-clone" class="ticker-value">-</span><span id="ticker-gold-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SILVER:</span><span id="ticker-silver-value-clone" class="ticker-value">-</span><span id="ticker-silver-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BTC-USD:</span><span id="ticker-btcusd-value-clone" class="ticker-value">-</span><span id="ticker-btcusd-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">USD-INR:</span><span id="ticker-usdinr-value-clone" class="ticker-value">-</span><span id="ticker-usdinr-change-clone" class="ticker-change">-</span></div>
            </div>
        </div>

        <div class="top-movers-container">
            <div class="movers-card">
                <h3 class="gainer-title">Top 10 Strongest (Bullish)</h3>
                <div class="table-container-small">
                    <table id="top-strongest-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="movers-card">
                <h3 class="loser-title">Top 10 Weakest (Bearish)</h3>
                <div class="table-container-small">
                    <table id="top-weakest-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="movers-card">
                <h3 class="gainer-title">Top 10 Getting Better (Potential Buys)</h3>
                <div class="table-container-small">
                    <table id="top-improving-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="movers-card">
                <h3 class="loser-title">Top 10 Getting Worsening (Potential Sells)</h3>
                <div class="table-container-small">
                    <table id="top-worsening-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NEW: AI Bot Trades Section (moved from tab to main page) -->
        <div class="ai-bot-trades-section">
            <h3 style="margin-top: 20px;">DeepSeek Analysis Bot Trades</h3>
            <p>This table displays the latest trade recommendations from the DeepSeek AI Bot for NIFTY, FINNIFTY, BANKNIFTY, and F&O Equities based on their option chain data.</p>
            <div class="table-container">
                <table id="ai-bot-trades-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Status</th> <!-- NEW -->
                            <th>P/L</th> <!-- NEW -->
                            <th>Action Price</th> <!-- NEW -->
                            <th>Trade</th>
                            <th>Strike(s)</th>
                            <th>Type</th>
                            <th>Risk %</th>
                            <th>Exit Rule</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Bot recommendations will be populated here by JavaScript -->
                        <tr><td colspan="10">Waiting for AI Bot recommendations...</td></tr> <!-- Colspan adjusted -->
                    </tbody>
                </table>
                <div id="ai-bot-rationale-container" style="margin-top: 15px;">
                    <h4>Latest Rationale:</h4>
                    <p id="ai-bot-rationale" style="font-style: italic;"></p>
                </div>
            </div>
        </div>

        <div id="market-pulse-container" class="market-pulse-container"></div>

        <div class="grid">
            <div class="card" id="NIFTY_summary">
                <h2>NIFTY</h2>
                <p>SP: <span id="nifty-sp">-</span></p>
                <p>Value: <span id="nifty-value">-</span></p>
                <!-- MODIFIED: Changed to call_coi_daily and put_coi_daily for clarity -->
                <p>Call COI (Day): <span id="nifty-call-coi-daily">-K</span></p>
                <p>Put COI (Day): <span id="nifty-put-coi-daily">-K</span></p>
                <p>PCR: <span id="nifty-pcr">-</span></p>
                <p>Sentiment: <span id="nifty-sentiment">-</span></p>
                <p>ML Sentiment: <span id="nifty-ml-sentiment">-</span></p>
                <p>Reason: <span id="nifty-sentiment-reason">-</span></p>
                <p>OI Changes: <span id="nifty-add-exit">-</span></p>
                <!-- NEW: Display Diff. in OI for the day -->
                <p>Diff. in OI (Day): <span id="nifty-diff-oi-daily">-</span></p>
            </div>
            <div class="card" id="FINNIFTY_summary">
                <h2>FINNIFTY</h2>
                <p>SP: <span id="finnifty-sp">-</span></p>
                <p>Value: <span id="finnifty-value">-</span></p>
                <!-- MODIFIED: Changed to call_coi_daily and put_coi_daily for clarity -->
                <p>Call COI (Day): <span id="finnifty-call-coi-daily">-K</span></p>
                <p>Put COI (Day): <span id="finnifty-put-coi-daily">-K</span></p>
                <p>PCR: <span id="finnifty-pcr">-</span></p>
                <p>Sentiment: <span id="finnifty-sentiment">-</span></p>
                <p>ML Sentiment: <span id="finnifty-ml-sentiment">-</span></p>
                <p>Reason: <span id="finnifty-sentiment-reason">-</span></p>
                <p>OI Changes: <span id="finnifty-add-exit">-</span></p>
                <!-- NEW: Display Diff. in OI for the day -->
                <p>Diff. in OI (Day): <span id="finnifty-diff-oi-daily">-</span></p>
            </div>
            <div class="card" id="BANKNIFTY_summary">
                <h2>BANKNIFTY</h2>
                <p>SP: <span id="banknifty-sp">-</span></p>
                <p>Value: <span id="banknifty-value">-</span></p>
                <!-- MODIFIED: Changed to call_coi_daily and put_coi_daily for clarity -->
                <p>Call COI (Day): <span id="banknifty-call-coi-daily">-K</span></p>
                <p>Put COI (Day): <span id="banknifty-put-coi-daily">-K</span></p>
                <p>PCR: <span id="banknifty-pcr">-</span></p>
                <p>Sentiment: <span id="banknifty-sentiment">-</span></p>
                <p>ML Sentiment: <span id="banknifty-ml-sentiment">-</span></p>
                <p>Reason: <span id="banknifty-sentiment-reason">-</span></p>
                <p>OI Changes: <span id="banknifty-add-exit">-</span></p>
                <!-- NEW: Display Diff. in OI for the day -->
                <p>Diff. in OI (Day): <span id="banknifty-diff-oi-daily">-</span></p>
            </div>
            <div class="card" id="SENSEX_summary">
                <h2>SENSEX</h2>
                <p>Value: <span id="sensex-value">-</span></p>
                <p>Change: <span id="sensex-change">-</span></p>
                <p>Pct Change: <span id="sensex-pct">-%</span></p>
                <p>Sentiment: <span id="sensex-sentiment">-</span></p>
                <p>ML Sentiment: <span id="sensex-ml-sentiment">-</span></p>
                <p>Reason: <span id="sensex-sentiment-reason">-</span></p>
            </div>
            <div class="card" id="INDIAVIX_summary">
                <h2>INDIAVIX</h2>
                <p>Value: <span id="indiavix-value">-</span></p>
                <p>Change: <span id="indiavix-change">-</span></p>
                <p>Pct Change: <span id="indiavix-pct">-%</span></p>
                <p>Sentiment: <span id="indiavix-sentiment">-</span></p>
                <p>ML Sentiment: <span id="indiavix-ml-sentiment">-</span></p>
                <p>Reason: <span id="indiavix-sentiment-reason">-</span></p>
            </div>
        </div>

        <div class="tabs">
            <button class="tablink active" onclick="openTab(event, 'NIFTY')" id="NIFTYOpen" data-symbol="NIFTY">NIFTY</button>
            <button class="tablink" onclick="openTab(event, 'FINNIFTY')" data-symbol="FINNIFTY">FINNIFTY</button>
            <button class="tablink" onclick="openTab(event, 'BANKNIFTY')" data-symbol="BANKNIFTY">BANKNIFTY</button>
            <button class="tablink" onclick="openTab(event, 'EQUITY')" data-symbol="EQUITY">Equity</button>
            <button class="tablink" onclick="openTab(event, 'SENSEX')" data-symbol="SENSEX">SENSEX</button>
            <button class="tablink" onclick="openTab(event, 'INDIAVIX')" data-symbol="INDIAVIX">INDIAVIX</button>
            <button class="tablink" onclick="openTab(event, 'BHAVCOPY_EQUITIES')" data-symbol="BHAVCOPY_EQUITIES">Bhavcopy (F&O)</button>
            <button class="tablink" onclick="openTab(event, 'BHAVCOPY_INDICES')" data-symbol="BHAVCOPY_INDICES">Bhavcopy (Indices)</button>
            <button class="tablink" onclick="openTab(event, 'BHAVCOPY_STRATEGIES')" data-symbol="BHAVCOPY_STRATEGIES">Bhavcopy Strategies</button>
            <!-- ADDED: News Tab -->
            <button class="tablink" onclick="openTab(event, 'NEWS')" data-symbol="NEWS">News</button>
            <!-- NEW: OI Change Summaries Tab -->
            <button class="tablink" onclick="openTab(event, 'OI_SUMMARIES')" data-symbol="OI_SUMMARIES">OI Summaries</button>
        </div>

        <div class="global-controls"><button class="clear-history-button" onclick="clearTodaysHistory(null)">Clear All Today's History</button></div>

        <div id="NIFTY_tab" class="tabcontent" style="display: block;">
            <h3 style="margin-top: 20px;">NIFTY Today's Updates (Newest First)</h3>
            <div class="table-container">
                <table id="nifty-todays-history-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to history table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h3>NIFTY Charts</h3>
            <div class="chart-grid">
                <div class="chart-container"><canvas id="nifty-pcr-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-intraday-pcr-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-max-pain-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-ce-oi-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-pe-oi-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-iv-skew-chart"></canvas></div>
                <!-- NEW CHARTS START -->
                <div class="chart-container"><canvas id="nifty-ce-coi-day-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-pe-coi-day-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-ce-coi-15min-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-pe-coi-15min-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-ce-coi-30min-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-pe-coi-30min-chart"></canvas></div>
                <!-- FIX: Added 60-min COI charts for NIFTY -->
                <div class="chart-container"><canvas id="nifty-ce-coi-60min-chart"></canvas></div>
                <div class="chart-container"><canvas id="nifty-pe-coi-60min-chart"></canvas></div>
                <!-- END FIX -->
                <!-- NEW CHARTS END -->
            </div>
            <h3>NIFTY Option Chain (ATM ±10)</h3><div class="table-container"><table id="nifty-table"><thead><tr><th>Call Buildup</th><th>Strike</th><th>Call OI</th><th>Call COI</th><th class="action-header">Call Action</th><th>Put OI</th><th>Put COI</th><th class="action-header">Put Action</th><th>Put Buildup</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">NIFTY Historical Data</h3>
            <div class="history-controls">
                <label for="nifty-history-date">Date:</label>
                <input type="date" id="nifty-history-date" class="history-date-picker">
                <button onclick="loadHistoricalData('NIFTY')">Load History</button>
                <button class="clear-history-button-small" onclick="clearTodaysHistory('NIFTY')">Clear Today's NIFTY History</button>
            </div>
            <div class="table-container">
                <table id="nifty-historical-data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to historical table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div id="FINNIFTY_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">FINNIFTY Today's Updates (Newest First)</h3>
            <div class="table-container">
                <table id="finnifty-todays-history-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to history table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h3>FINNIFTY Charts</h3>
            <div class="chart-grid">
                <div class="chart-container"><canvas id="finnifty-pcr-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-intraday-pcr-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-max-pain-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-ce-oi-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-pe-oi-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-iv-skew-chart"></canvas></div>
                <!-- NEW CHARTS START -->
                <div class="chart-container"><canvas id="finnifty-ce-coi-day-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-pe-coi-day-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-ce-coi-15min-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-pe-coi-15min-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-ce-coi-30min-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-pe-coi-30min-chart"></canvas></div>
                <!-- FIX: Added 60-min COI charts for FINNIFTY -->
                <div class="chart-container"><canvas id="finnifty-ce-coi-60min-chart"></canvas></div>
                <div class="chart-container"><canvas id="finnifty-pe-coi-60min-chart"></canvas></div>
                <!-- END FIX -->
                <!-- NEW CHARTS END -->
            </div>
            <h3>FINNIFTY Option Chain (ATM ±10)</h3><div class="table-container"><table id="finnifty-table"><thead><tr><th>Call Buildup</th><th>Strike</th><th>Call OI</th><th>Call COI</th><th class="action-header">Call Action</th><th>Put OI</th><th>Put COI</th><th class="action-header">Put Action</th><th>Put Buildup</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">FINNIFTY Historical Data</h3>
            <div class="history-controls">
                <label for="finnifty-history-date">Date:</label>
                <input type="date" id="finnifty-history-date" class="history-date-picker">
                <button onclick="loadHistoricalData('FINNIFTY')">Load History</button>
                <button class="clear-history-button-small" onclick="clearTodaysHistory('FINNIFTY')">Clear Today's FINNIFTY History</button>
            </div>
            <div class="table-container">
                <table id="finnifty-historical-data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to historical table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div id="BANKNIFTY_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">BANKNIFTY Today's Updates (Newest First)</h3>
            <div class="table-container">
                <table id="banknifty-todays-history-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to history table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h3>BANKNIFTY Charts</h3>
            <div class="chart-grid">
                <div class="chart-container"><canvas id="banknifty-pcr-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-intraday-pcr-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-max-pain-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-ce-oi-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-pe-oi-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-iv-skew-chart"></canvas></div>
                <!-- NEW CHARTS START -->
                <div class="chart-container"><canvas id="banknifty-ce-coi-day-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-pe-coi-day-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-ce-coi-15min-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-pe-coi-15min-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-ce-coi-30min-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-pe-coi-30min-chart"></canvas></div>
                <!-- FIX: Added 60-min COI charts for BANKNIFTY -->
                <div class="chart-container"><canvas id="banknifty-ce-coi-60min-chart"></canvas></div>
                <div class="chart-container"><canvas id="banknifty-pe-coi-60min-chart"></canvas></div>
                <!-- END FIX -->
                <!-- NEW CHARTS END -->
            </div>
            <h3>BANKNIFTY Option Chain (ATM ±10)</h3><div class="table-container"><table id="banknifty-table"><thead><tr><th>Call Buildup</th><th>Strike</th><th>Call OI</th><th>Call COI</th><th class="action-header">Call Action</th><th>Put OI</th><th>Put COI</th><th class="action-header">Put Action</th><th>Put Buildup</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">BANKNIFTY Historical Data</h3>
            <div class="history-controls">
                <label for="banknifty-history-date">Date:</label>
                <input type="date" id="banknifty-history-date" class="history-date-picker">
                <button onclick="loadHistoricalData('BANKNIFTY')">Load History</button>
                <button class="clear-history-button-small" onclick="clearTodaysHistory('BANKNIFTY')">Clear Today's BANKNIFTY History</button>
            </div>
            <div class="table-container">
                <table id="banknifty-historical-data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to historical table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div id="SENSEX_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">SENSEX Today's Updates (Newest First)</h3><div class="table-container"><table id="sensex-todays-history-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment (Rule-Based)</th><th>Sentiment (ML-Based)</th><th>Reason for Sentiment</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">SENSEX Historical Data</h3><div class="history-controls"><label for="sensex-history-date">Date:</label><input type="date" id="sensex-history-date" class="history-date-picker"><button onclick="loadHistoricalData('SENSEX')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('SENSEX')">Clear Today's SENSEX History</button></div>
            <div class="table-container"><table id="sensex-historical-data-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment (Rule-Based)</th><th>Sentiment (ML-Based)</th><th>Reason for Sentiment</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="INDIAVIX_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">INDIAVIX Today's Updates (Newest First)</h3><div class="table-container"><table id="indiavix-todays-history-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment (Rule-Based)</th><th>Sentiment (ML-Based)</th><th>Reason for Sentiment</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">INDIAVIX Historical Data</h3><div class="history-controls"><label for="indiavix-history-date">Date:</label><input type="date" id="indiavix-history-date" class="history-date-picker"><button onclick="loadHistoricalData('INDIAVIX')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('INDIAVIX')">Clear Today's INDIAVIX History</button></div>
            <div class="table-container"><table id="indiavix-historical-data-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment (Rule-Based)</th><th>Sentiment (ML-Based)</th><th>Reason for Sentiment</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="EQUITY_tab" class="tabcontent">
            <div class="equity-selector-bar">
                <label for="equity-symbol-selector">Select Stock:</label>
                <select id="equity-symbol-selector" style="width: 250px;"></select>
                <button id="fetch-equity-btn">Fetch Data</button>
            </div>
            <div id="equity-data-container" class="hidden">
                <h2 id="equity-title" style="text-align: center; margin-bottom: 20px;"></h2>
                <div id="equity-market-pulse-container" class="market-pulse-container"></div>
                <div class="grid">
                    <div class="card" id="EQUITY_summary_card">
                        <h2>Summary</h2>
                        <p>SP: <span id="equity-sp">-</span></p>
                        <p>Value: <span id="equity-value">-</span></p>
                        <!-- MODIFIED: Changed to call_coi_daily and put_coi_daily for clarity -->
                        <p>Call COI (Day): <span id="equity-call-coi-daily">-K</span></p>
                        <p>Put COI (Day): <span id="equity-put-coi-daily">-K</span></p>
                        <p>PCR: <span id="equity-pcr">-</span></p>
                        <p>Intraday PCR: <span id="equity-intraday-pcr-value">-</span></p> <!-- FIX: Added span tag for value, changed ID for consistency -->
                        <p>Sentiment (Rule-Based): <span id="equity-sentiment">-</span></p>
                        <p>Sentiment (ML-Based): <span id="equity-ml-sentiment">-</span></p>
                        <p>Reason: <span id="equity-sentiment-reason">-</span></p>
                        <!-- NEW: Display Diff. in OI for the day -->
                        <p>Diff. in OI (Day): <span id="equity-diff-oi-daily">-</span></p>
                    </div>
                </div>
                <!-- Equity Charts -->
                <h3>Equity Charts</h3>
                <div class="chart-grid">
                    <div class="chart-container"><canvas id="equity-pcr-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-intraday-pcr-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-max-pain-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-ce-oi-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-pe-oi-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-iv-skew-chart"></canvas></div>
                    <!-- NEW CHARTS START -->
                    <div class="chart-container"><canvas id="equity-ce-coi-day-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-pe-coi-day-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-ce-coi-15min-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-pe-coi-15min-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-ce-coi-30min-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-pe-coi-30min-chart"></canvas></div>
                    <!-- FIX: Added 60-min COI charts for EQUITY -->
                    <div class="chart-container"><canvas id="equity-ce-coi-60min-chart"></canvas></div>
                    <div class="chart-container"><canvas id="equity-pe-coi-60min-chart"></canvas></div>
                    <!-- END FIX -->
                    <!-- NEW CHARTS END -->
                </div>
                <h3>Option Chain (ATM ±10)</h3>
                <div class="table-container">
                    <table id="equity-table">
                        <thead>
                            <tr>
                                <th>Call Buildup</th>
                                <th>Strike</th>
                                <th>Call OI</th>
                                <th>Call COI</th>
                                <th class="action-header">Call Action</th>
                                <th>Put OI</th>
                                <th>Put COI</th>
                                <th class="action-header">Put Action</th>
                                <th>Put Buildup</th>
                            </tr>
                        </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h3 style="margin-top: 20px;">Equity Historical Data</h3>
            <div class="history-controls">
                <label for="equity-history-date">Date:</label>
                <input type="date" id="equity-history-date" class="history-date-picker">
                <button onclick="loadHistoricalData('EQUITY')">Load History</button>
            </div>
            <div class="table-container">
                <table id="equity-historical-data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>SP</th>
                            <th>Value</th>
                            <!-- MODIFIED: Changed to Call COI (Day) and Put COI (Day) for clarity -->
                            <th>Call COI (Day)</th>
                            <th>Put COI (Day)</th>
                            <th>PCR</th>
                            <th>Intraday PCR</th>
                            <th>Reason for Sentiment</th>
                            <th>Sentiment (Rule-Based)</th>
                            <th>Sentiment (ML-Based)</th>
                            <th style="width: 30%;">OI Changes</th>
                            <!-- NEW: Added Diff. in OI (Day) to historical table -->
                            <th>Diff. in OI (Day)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            </div>
            <div id="equity-loader" class="hidden" style="text-align: center; padding: 40px;">Loading...</div>
            <div id="equity-error" class="hidden" style="text-align: center; padding: 40px; color: #F44336;"></div>
        </div>

        <!-- NEW: BHAVCOPY F&O EQUITIES TAB -->
        <div id="BHAVCOPY_EQUITIES_tab" class="tabcontent">
            <h3 id="bhavcopy-equity-title">Bhavcopy Daily Scan - F&O Equities (<span id="bhavcopy-equity-date">Loading...</span>)</h3>
            <div class="bhavcopy-controls">
                <button id="run-bhavcopy-btn">Run Automatic Bhavcopy Scan</button>
                <div class="history-controls" style="justify-content: center;">
                    <label for="bhavcopy-equity-history-date">View Historical Date:</label>
                    <input type="date" id="bhavcopy-equity-history-date" class="history-date-picker">
                    <button onclick="loadBhavcopyHistory('equities')">Load F&O History</button>
                </div>
            </div>
            <p id="bhavcopy-equity-status" style="text-align: center; margin-bottom: 20px;">Fetching latest Bhavcopy F&O equities data...</p>
            <div class="table-container">
                <table id="bhavcopy-equity-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Instrument</th>
                            <th>Expiry Date</th>
                            <th>Strike Price</th>
                            <th>Option Type</th>
                            <th>Open Interest</th>
                            <th>Change in OI</th>
                            <th>Volume</th>
                            <th>Close</th>
                            <th>Delivery %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p id="no-bhavcopy-equity-data" class="no-data-message" style="display: none;">No F&O equity Bhavcopy data available for this date.</p>
            </div>
        </div>

        <!-- NEW: BHAVCOPY INDICES TAB -->
        <div id="BHAVCOPY_INDICES_tab" class="tabcontent">
            <h3 id="bhavcopy-indices-title">Bhavcopy Daily Scan - Indices (<span id="bhavcopy-indices-date">Loading...</span>)</h3>
            <div class="bhavcopy-controls">
                <!-- Manual scan button is shared, so not duplicated here. -->
                <div class="history-controls" style="justify-content: center;">
                    <label for="bhavcopy-indices-history-date">View Historical Date:</label>
                    <input type="date" id="bhavcopy-indices-history-date" class="history-date-picker">
                    <button onclick="loadBhavcopyHistory('indices')">Load Indices History</button>
                </div>
            </div>
            <p id="bhavcopy-indices-status" style="text-align: center; margin-bottom: 20px;">Fetching latest Bhavcopy indices data...</p>
            <div class="table-container">
                <table id="bhavcopy-indices-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Close</th>
                            <th>% Change</th>
                            <th>Open</th>
                            <th>High</th>
                            <th>Low</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p id="no-bhavcopy-indices-data" class="no-data-message" style="display: none;">No index Bhavcopy data available for this date.</p>
            </div>
        </div>


        <!-- NEW: Bhavcopy Strategies Tab -->
        <div id="BHAVCOPY_STRATEGIES_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">Bhavcopy Derived Trading Strategies</h3>
            <p>Select a date to analyze Bhavcopy data for potential trading signals. The strategies below are generated based on the selected day's data.</p>
            <div class="history-controls" style="justify-content: center; margin-top: 15px; margin-bottom: 20px;">
                <label for="strategy-bhavcopy-date">Select Date:</label>
                <input type="date" id="strategy-bhavcopy-date" class="history-date-picker">
                <button onclick="analyzeBhavcopyStrategies()">Analyze Strategies</button>
            </div>

            <div id="strategy-results-container">
                <p id="strategy-status" style="text-align: center; margin-bottom: 20px;">Select a date and click "Analyze Strategies" to see results.</p>

                <h4>1. FII-DII Delivery Divergence Trap (FDDT)</h4>
                <div class="table-container">
                    <table id="strategy-fddt-table">
                        <thead><tr><th>Symbol</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="2">No data available. (Requires FII/DII data integration)</td></tr></tbody>
                    </table>
                </div>

                <h4>2. Zero-Delivery Future Roll Trap (ZDFT)</h4>
                <div class="table-container">
                    <table id="strategy-zdft-table">
                        <thead><tr><th>Symbol</th><th>Near Month Delivery %</th><th>Next Month OI Increase %</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="4">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>3. Block-Deal Ghost Pump (BDGP)</h4>
                <div class="table-container">
                    <table id="strategy-bdgp-table">
                        <thead><tr><th>Symbol</th><th>Block Deal Price</th><th>Previous Close</th><th>Open Price</th><th>Block Discount %</th><th>Open Gap Up %</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="7">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>4. VWAP Anchor Reversion (VAR-7)</h4>
                <div class="table-container">
                    <table id="strategy-var7-table">
                        <thead><tr><th>Symbol</th><th>Close Price</th><th>VWAP</th><th>Close vs VWAP %</th><th>Delivery %</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="6">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>5. Hidden Bonus Arbitrage (HBA-21)</h4>
                <div class="table-container">
                    <table id="strategy-hba21-table">
                        <thead><tr><th>Symbol</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="2">No data available. (Requires Corporate Actions data and multi-day delivery trend analysis)</td></tr></tbody>
                    </table>
                </div>

                <h4>6. OI Momentum Trap (Long Buildup vs. Short Covering Detector)</h4>
                <div class="table-container">
                    <table id="strategy-oimt-table">
                        <thead><tr><th>Symbol</th><th>Price Change %</th><th>OI Change</th><th>Signal Type</th><th>Institutional Conviction (Delivery > 60%)</th></tr></thead>
                        <tbody><tr><td colspan="5">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>7. Volume Surge Scanner for Swing Breakouts</h4>
                <div class="table-container">
                    <table id="strategy-vssb-table">
                        <thead><tr><th>Symbol</th><th>Today's Volume</th><th>10-Day Avg Volume</th><th>Volume Multiple</th><th>Delivery %</th><th>Price Change %</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="7">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>8. Options OI Anomaly for Directional Bets</h4>
                <div class="table-container">
                    <table id="strategy-ooad-table">
                        <thead><tr><th>Symbol</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="2">No data available. (Requires detailed Options Bhavcopy parsing and storage)</td></tr></tbody>
                    </table>
                </div>

                <h4>9. Corporate Action Arbitrage via Delivery Traps</h4>
                <div class="table-container">
                    <table id="strategy-caadt-table">
                        <thead><tr><th>Symbol</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="2">No data available. (Requires Corporate Actions data and multi-day delivery trend analysis)</td></tr></tbody>
                    </table>
                </div>

            </div>
        </div>

        <!-- NEW: News Tab -->
        <div id="NEWS_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">Latest Indian Market News Headlines</h3>
            <p id="news-status" style="text-align: center; margin-bottom: 20px;">Fetching latest news...</p>
            <div class="table-container">
                <table id="news-table">
                    <thead>
                        <tr>
                            <th>Time (IST)</th>
                            <th>Headline</th>
                            <th>Source</th>
                            <th>Key Details</th>
                            <th>Impact</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6">No news available.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- NEW: OI Change Summaries Tab -->
        <div id="OI_SUMMARIES_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">Live OI Change Summaries</h3>
            <p>This section displays significant OI shifts across different timeframes for NIFTY, FINNIFTY, BANKNIFTY, and currently selected F&O Equities.</p>
            <div id="live-oi-summaries-container" class="oi-summary-grid">
                <!-- OI summaries will be dynamically loaded here -->
                <p style="text-align: center;">Waiting for live OI summary data...</p>
            </div>

            <h3 style="margin-top: 20px;">Historical OI First & Last Hour Summaries</h3>
            <div class="history-controls" style="justify-content: center; margin-top: 15px; margin-bottom: 20px;">
                <label for="oi-summary-history-symbol-selector">Select Symbol:</label>
                <select id="oi-summary-history-symbol-selector" style="width: 150px;"></select>
                <label for="oi-summary-history-date">Select Date:</label>
                <input type="date" id="oi-summary-history-date" class="history-date-picker">
                <button onclick="loadOiSummaryHistory()">Load Historical OI Summary</button>
            </div>
            <div id="historical-oi-summaries-container">
                <p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;">Select a symbol and date to view historical OI summaries.</p>
                <!-- Historical OI summaries will be dynamically loaded here -->
            </div>
        </div>


        <footer>@aditya_nse_bot | Updated: <span id="time">-</span> | Site Visits: <span id="visit-counter">-</span></footer>
    </div>

    <div class="disclaimer-ticker-wrap">
        <div class="disclaimer-ticker">
            <span class="disclaimer-text">Disclaimer: 9 out of 10 individual traders in the Equity Futures and Options Segment incurred net losses. On average, loss-makers registered net trading losses close to ₹50,000. Over and above the net trading losses incurred, loss-makers expended an additional 28% of net trading losses as transaction costs. This tool is for educational purposes only and does not constitute investment advice. Please consult a SEBI-registered financial advisor before trading.
            </span>
            <span class="disclaimer-text">Disclaimer: 9 out of 10 individual traders in the Equity Futures and Options Segment incurred net losses. On average, loss-makers registered net trading losses close to ₹50,000. Over and above the net trading losses incurred, loss-makers expended an additional 28% of net trading losses as transaction costs. This tool is for educational purposes only and does not constitute investment advice. Please consult a SEBI-registered financial advisor before trading.
            </span>
        </div>
    </div>

<script>
    const socket = io();
    const chartInstances = {}; // Object to store Chart.js instances
    const shared_data_cache = {};
    let fno_stocks_list_global = []; // Global variable to store fetched F&O stocks

    const ALL_SYMBOLS = ["NIFTY", "FINNIFTY", "BANKNIFTY", "SENSEX", "INDIAVIX", "GOLD", "SILVER", "BTC-USD", "USD-INR"];
    const OI_SYMBOLS = ["NIFTY", "FINNIFTY", "BANKNIFTY"]; // Indices that use Option Chain data
    const YF_ASSETS = ["SENSEX", "INDIAVIX", "GOLD", "SILVER", "BTC-USD", "USD-INR"]; // All YFinance assets

    function openTab(evt, symbol) {
        console.log("openTab called for:", symbol);
        document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
        document.querySelectorAll(".tablink").forEach(el => el.classList.remove("active"));

        const tabId = `${symbol}_tab`;
        const tabElement = document.getElementById(tabId);
        if (tabElement) {
            tabElement.style.display = "block";
            // Only add active class if evt.currentTarget exists (i.e., it's a direct click)
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            } else {
                // If called programmatically, find the button and add active class
                const button = document.querySelector(`.tablink[data-symbol="${symbol}"]`);
                if (button) button.classList.add('active');
            }
        }


        // Only update charts for OI-based symbols (Nifty, Banknifty, Finnifty, Equity)
        if (OI_SYMBOLS.includes(symbol) || symbol === "EQUITY") {
            const currentSymbol = symbol === "EQUITY" ? $('#equity-symbol-selector').val() : symbol;
            if (currentSymbol && shared_data_cache[currentSymbol]) {
                updateCharts(currentSymbol, shared_data_cache[currentSymbol]);
                // Also update the summary card for the selected equity
                if (symbol === "EQUITY") {
                    updateEquitySummaryCard(currentSymbol, shared_data_cache[currentSymbol]);
                }
            }
        }

        if (symbol === "BHAVCOPY_EQUITIES" || symbol === "BHAVCOPY_INDICES") {
            console.log("Loading initial Bhavcopy data for tab:", symbol);
            loadInitialBhavcopyData();
        }
        if (symbol === "BHAVCOPY_STRATEGIES") {
            const today = moment().format('YYYY-MM-DD');
            const strategyDateInput = document.getElementById('strategy-bhavcopy-date');
            if (strategyDateInput) strategyDateInput.value = today;

            const strategyStatusEl = document.getElementById('strategy-status');
            if (strategyStatusEl) {
                strategyStatusEl.textContent = 'Select a date and click "Analyze Strategies" to see results.';
                strategyStatusEl.style.color = '';
            }

            document.querySelectorAll('#strategy-results-container table tbody').forEach(tbody => {
                const colspan = tbody.previousElementSibling.querySelector('thead tr').children.length;
                tbody.innerHTML = `<tr><td colspan="${colspan}">Initializing...</td></tr>`;
            });
        }
        if (symbol === "NEWS") {
            renderNewsTable(news_alerts);
        }
        if (symbol === "OI_SUMMARIES") {
            // Render live OI summaries first
            if (shared_data_cache.oi_change_summaries) { // Check if live OI summaries are in cache
                renderLiveOiSummaries(shared_data_cache.oi_change_summaries);
            } else {
                const liveOiContainer = document.getElementById('live-oi-summaries-container');
                if (liveOiContainer) liveOiContainer.innerHTML = `<p style="text-align: center;">Waiting for live OI summary data...</p>`;
            }

            // Then handle historical - ensure selectors have values before attempting to load
            const oiSummaryHistorySymbolSelector = $('#oi-summary-history-symbol-selector');
            const selectedSymbol = oiSummaryHistorySymbolSelector.val();
            const selectedDate = document.getElementById('oi-summary-history-date').value;

            if (selectedSymbol && selectedDate) {
                loadOiSummaryHistory(); // Call without args, it reads from selectors
            } else {
                const historicalOiContainer = document.getElementById('historical-oi-summaries-container');
                if (historicalOiContainer) historicalOiContainer.innerHTML = `<p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;">Select a symbol and date to view historical OI summaries.</p>`;
            }
        }
    }

    function renderChart(canvasId, type, labels, data, label, backgroundColor, borderColor, options = {}) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }

        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ccc'
                    }
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x',
                    },
                    pan: {
                        enabled: true,
                        mode: 'x',
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#ccc',
                    },
                    grid: {
                        color: 'rgba(200, 200, 200, 0.1)',
                    }
                },
                y: {
                    ticks: {
                        color: '#ccc',
                    },
                    grid: {
                        color: 'rgba(200, 200, 200, 0.1)',
                    }
                }
            },
            animation: {
                duration: 0
            },
            elements: {
                line: {
                    tension: 0.3
                }
            }
        };

        const mergedOptions = { ...defaultOptions, ...options };

        chartInstances[canvasId] = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 1,
                    fill: type === 'line' ? true : false,
                }]
            },
            options: mergedOptions
        });
    }


    function updateCharts(symbol, liveData) {
        // Ensure liveData is not null or undefined
        if (!liveData) {
            console.warn(`No liveData available for charts for ${symbol}`);
            return;
        }
        console.log(`Updating charts for ${symbol}`, liveData);

        const lower = symbol.toLowerCase();

        // Only render charts if data is available and symbol is OI-based
        if (!OI_SYMBOLS.includes(symbol) && symbol !== "EQUITY") {
            return; // No charts for YFinance symbols or non-OI-based equities
        }

        // Helper to safely get chart data, defaulting to empty array if not present
        const getChartData = (key) => liveData[key] || [];

        // PCR Chart
        const pcrChartData = getChartData('pcr_chart_data');
        const pcrLabels = pcrChartData.map(d => d.TIME);
        const pcrData = pcrChartData.map(d => d.PCR);
        renderChart(`${lower}-pcr-chart`, 'line', pcrLabels, pcrData, `${symbol} PCR`, 'rgba(75, 192, 192, 0.2)', 'rgba(75, 192, 192, 1)');

        // Intraday PCR Chart
        const intradayPcrLabels = pcrChartData.map(d => d.TIME);
        const intradayPcrData = pcrChartData.map(d => d.IntradayPCR);
        renderChart(`${lower}-intraday-pcr-chart`, 'line', intradayPcrLabels, intradayPcrData, `${symbol} Intraday PCR`, 'rgba(153, 102, 255, 0.2)', 'rgba(153, 102, 255, 1)');

        // Max Pain Chart (Bar Chart)
        const mpChartData = getChartData('max_pain_chart_data');
        const mpLabels = mpChartData.map(d => d.StrikePrice);
        const mpData = mpChartData.map(d => d.TotalMaxPain);
        renderChart(`${lower}-max-pain-chart`, 'bar', mpLabels, mpData, `${symbol} Max Pain`, 'rgba(255, 159, 64, 0.5)', 'rgba(255, 159, 64, 1)');

        // CE OI Chart (Bar Chart) - This is total OI
        const ceOiChartData = getChartData('ce_oi_chart_data');
        const ceLabels = ceOiChartData.map(d => d.strikePrice);
        const ceData = ceOiChartData.map(d => d.openInterest);
        renderChart(`${lower}-ce-oi-chart`, 'bar', ceLabels, ceData, `${symbol} CE OI (Total)`, 'rgba(255, 99, 132, 0.5)', 'rgba(255, 99, 132, 1)');

        // PE OI Chart (Bar Chart) - This is total OI
        const peOiChartData = getChartData('pe_oi_chart_data');
        const peLabels = peOiChartData.map(d => d.strikePrice);
        const peData = peOiChartData.map(d => d.openInterest);
        renderChart(`${lower}-pe-oi-chart`, 'bar', peLabels, peData, `${symbol} PE OI (Total)`, 'rgba(54, 162, 235, 0.5)', 'rgba(54, 162, 235, 1)');

        // IV Skew Chart (Line Chart)
        const ivSkewChartData = getChartData('iv_skew_chart_data');
        const ivSkewLabels = ivSkewChartData.map(d => d.strike);
        const callIvData = ivSkewChartData.map(d => d.call_iv);
        const putIvData = ivSkewChartData.map(d => d.put_iv);

        const ivSkewCtx = document.getElementById(`${lower}-iv-skew-chart`);
        if (ivSkewCtx) {
            if (chartInstances[`${lower}-iv-skew-chart`]) {
                chartInstances[`${lower}-iv-skew-chart`].destroy();
            }
            chartInstances[`${lower}-iv-skew-chart`] = new Chart(ivSkewCtx, {
                type: 'line',
                data: {
                    labels: ivSkewLabels,
                    datasets: [
                        {
                            label: 'Call IV',
                            data: callIvData,
                            backgroundColor: 'rgba(255, 165, 0, 0.2)', // Orange for Call IV
                            borderColor: 'rgba(255, 165, 0, 1)',
                            borderWidth: 1,
                            fill: false,
                        },
                        {
                            label: 'Put IV',
                            data: putIvData,
                            backgroundColor: 'rgba(0, 128, 0, 0.2)', // Green for Put IV
                            borderColor: 'rgba(0, 128, 0, 1)',
                            borderWidth: 1,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ccc'
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ccc',
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.1)',
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ccc',
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.1)',
                            },
                            title: {
                                display: true,
                                text: 'Implied Volatility (%)',
                                color: '#ccc'
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    },
                    elements: {
                        line: {
                            tension: 0.3
                        }
                    }
                }
            });
        }

        // NEW CHARTS: CE Change in OI (for the day)
        const ceCoiDayChartData = getChartData('ce_coi_day_chart_data');
        const ceCoiDayLabels = ceCoiDayChartData.map(d => d.strikePrice);
        const ceCoiDayData = ceCoiDayChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-ce-coi-day-chart`, 'bar', ceCoiDayLabels, ceCoiDayData, `${symbol} CE COI (Day)`, 'rgba(255, 206, 86, 0.5)', 'rgba(255, 206, 86, 1)');

        // NEW CHARTS: PE Change in OI (for the day)
        const peCoiDayChartData = getChartData('pe_coi_day_chart_data');
        const peCoiDayLabels = peCoiDayChartData.map(d => d.strikePrice);
        const peCoiDayData = peCoiDayChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-pe-coi-day-chart`, 'bar', peCoiDayLabels, peCoiDayData, `${symbol} PE COI (Day)`, 'rgba(75, 192, 192, 0.5)', 'rgba(75, 192, 192, 1)');

        // NEW CHARTS: CE Change in OI (last 15 mins)
        const ceCoi15MinChartData = getChartData('ce_coi_15min_chart_data');
        const ceCoi15MinLabels = ceCoi15MinChartData.map(d => d.strikePrice);
        const ceCoi15MinData = ceCoi15MinChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-ce-coi-15min-chart`, 'bar', ceCoi15MinLabels, ceCoi15MinData, `${symbol} CE COI (15 min)`, 'rgba(255, 100, 100, 0.5)', 'rgba(255, 100, 100, 1)');

        // NEW CHARTS: PE Change in OI (last 15 mins)
        const peCoi15MinChartData = getChartData('pe_coi_15min_chart_data');
        const peCoi15MinLabels = peCoi15MinChartData.map(d => d.strikePrice);
        const peCoi15MinData = peCoi15MinChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-pe-coi-15min-chart`, 'bar', peCoi15MinLabels, peCoi15MinData, `${symbol} PE COI (15 min)`, 'rgba(100, 255, 100, 0.5)', 'rgba(100, 255, 100, 1)');

        // NEW CHARTS: CE Change in OI (last 30 mins)
        const ceCoi30MinChartData = getChartData('ce_coi_30min_chart_data');
        const ceCoi30MinLabels = ceCoi30MinChartData.map(d => d.strikePrice);
        const ceCoi30MinData = ceCoi30MinChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-ce-coi-30min-chart`, 'bar', ceCoi30MinLabels, ceCoi30MinData, `${symbol} CE COI (30 min)`, 'rgba(200, 50, 50, 0.5)', 'rgba(200, 50, 50, 1)');

        // NEW CHARTS: PE Change in OI (last 30 mins)
        const peCoi30MinChartData = getChartData('pe_coi_30min_chart_data');
        const peCoi30MinLabels = peCoi30MinChartData.map(d => d.strikePrice);
        const peCoi30MinData = peCoi30MinChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-pe-coi-30min-chart`, 'bar', peCoi30MinLabels, peCoi30MinData, `${symbol} PE COI (30 min)`, 'rgba(50, 200, 50, 0.5)', 'rgba(50, 200, 50, 1)');

        // FIX: Added 60-min COI charts for NIFTY
        const ceCoi60MinChartData = getChartData('ce_coi_60min_chart_data');
        const ceCoi60MinLabels = ceCoi60MinChartData.map(d => d.strikePrice);
        const ceCoi60MinData = ceCoi60MinChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-ce-coi-60min-chart`, 'bar', ceCoi60MinLabels, ceCoi60MinData, `${symbol} CE COI (60 min)`, 'rgba(150, 150, 250, 0.5)', 'rgba(150, 150, 250, 1)');

        // FIX: Added 60-min COI charts for NIFTY
        const peCoi60MinChartData = getChartData('pe_coi_60min_chart_data');
        const peCoi60MinLabels = peCoi60MinChartData.map(d => d.strikePrice);
        const peCoi60MinData = peCoi60MinChartData.map(d => d.changeinOpenInterest);
        renderChart(`${lower}-pe-coi-60min-chart`, 'bar', peCoi60MinLabels, peCoi60MinData, `${symbol} PE COI (60 min)`, 'rgba(250, 150, 150, 0.5)', 'rgba(250, 150, 150, 1)');
        // END FIX
    }


    function formatNumber(num, decimals = 2) {
        if (num === null || num === undefined || num === 'N/A' || num === '-' || isNaN(num)) return 'N/A';
        if (typeof num === 'string' && num.includes('%')) return num;
        const parsedNum = parseFloat(num);
        if (!isNaN(parsedNum)) {
            // Check if it's an integer value, then format without decimals if requested
            if (decimals === 0 && Number.isInteger(parsedNum)) {
                 return parsedNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return parsedNum.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        return num;
    }

    function getChangeColorClass(value) {
        if (value === null || value === undefined || isNaN(value)) return 'neutral';
        const parsedValue = parseFloat(value);
        if (parsedValue > 0) return 'positive';
        if (parsedValue < 0) return 'negative';
        return 'neutral';
    }

    function getPnLClass(pnl) {
        if (pnl > 0) return 'positive';
        if (pnl < 0) return 'negative';
        return 'neutral';
    }

    // MODIFIED: addHistoryItemToTable to correctly map YFinance data
    function addHistoryItemToTable(tbody, item, symbol, prepend = false) {
        const tr = document.createElement('tr');
        if (YF_ASSETS.includes(symbol)) { // For YFinance assets
            const changeVal = item.sp; // This is actually 'change' from backend
            const pctChangeVal = item.pcr; // This is actually 'percentage_change' from backend
            tr.innerHTML = `
                <td>${item.time}</td>
                <td>${formatNumber(item.value)}</td>
                <td class="${getChangeColorClass(changeVal)}">${changeVal >= 0 ? '+' : ''}${formatNumber(changeVal)}</td>
                <td class="${getChangeColorClass(pctChangeVal)}">${pctChangeVal >= 0 ? '+' : ''}${formatNumber(pctChangeVal)}%</td>
                <td class="${item.sentiment.includes('Bullish') ? 'positive' : (item.sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${item.sentiment}</td>
                <td>${item.ml_sentiment || 'N/A'}</td>
                <td>${item.sentiment_reason || 'N/A'}</td>
            `;
        } else { // For OI_SYMBOLS and Equity F&O
            const intradayPcr = item.intraday_pcr || 0.0;
            const intradayPcrClass = intradayPcr > 1.2 ? 'positive' : (intradayPcr < 0.8 && intradayPcr !== 0) ? 'negative' : 'neutral';
            const diffOiDailyClass = getChangeColorClass(item.diff_oi_daily);
            tr.innerHTML = `
                <td>${item.time}</td>
                <td>${formatNumber(item.sp,0)}</td>
                <td>${formatNumber(item.value)}</td>
                <td>${formatNumber(item.call_coi_daily,1)}K</td>
                <td>${formatNumber(item.put_coi_daily,1)}K</td>
                <td>${formatNumber(item.pcr)}</td>
                <td class="${intradayPcrClass}">${formatNumber(intradayPcr)}</td>
                <td>${item.sentiment_reason || 'N/A'}</td>
                <td class="${item.sentiment.includes('Bullish') ? 'positive' : (item.sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${item.sentiment}</td>
                <td class="${item.ml_sentiment && item.ml_sentiment.includes('Bullish') ? 'positive' : (item.ml_sentiment && item.ml_sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${item.ml_sentiment || 'N/A'}</td>
                <td>${item.add_exit || '-'}</td>
                <td class="${diffOiDailyClass}">${formatNumber(item.diff_oi_daily, 0)}</td> <!-- NEW: Display Diff. in OI (Day) -->
            `;
        }
        if (prepend) tbody.prepend(tr); else tbody.appendChild(tr);
    }

    async function loadHistoricalData(symbol) {
        console.log("loadHistoricalData called for:", symbol);
        let effectiveSymbol = symbol;
        if (symbol === 'EQUITY') {
            effectiveSymbol = $('#equity-symbol-selector').val();
            if (!effectiveSymbol) {
                alert("Please select a stock first.");
                return;
            }
        }
        const lower = effectiveSymbol.toLowerCase(); // Use effectiveSymbol here for consistency with IDs
        const dateInput = document.getElementById(`${lower}-history-date`);
        const historicalTbody = document.querySelector(`#${lower}-historical-data-table tbody`);
        if (!dateInput || !historicalTbody) return;

        const selectedDate = dateInput.value;
        if (!selectedDate) { alert("Please select a date."); return; }

        // MODIFIED: Colspan adjusted for ml_sentiment, sentiment_reason, and diff_oi_daily
        const colspan = YF_ASSETS.includes(effectiveSymbol) ? 7 : 12; // 7 for YFinance, 12 for OI-based
        historicalTbody.innerHTML = `<tr><td colspan="${colspan}">Loading...</td></tr>`;
        try {
            const response = await fetch(`/history/${effectiveSymbol}/${selectedDate}`);
            const data = await response.json();
            console.log("Received historical data for", effectiveSymbol, selectedDate, ":", data);
            historicalTbody.innerHTML = '';
            if (data.error || data.history.length === 0) {
                historicalTbody.innerHTML = `<tr><td colspan="${colspan}" class="negative">${data.error || 'No data found for this date.'}</td></tr>`;
                return;
            }
            // Sort history for display (newest first, as it's typically how historical data is presented)
            const sortedHistory = data.history.sort((a, b) => {
                const timeA = moment(a.time, "HH:mm");
                const timeB = moment(b.time, "HH:mm");
                return timeB.diff(timeA); // Newest first
            });
            sortedHistory.forEach(item => addHistoryItemToTable(historicalTbody, item, effectiveSymbol, false));
        } catch (error) {
            historicalTbody.innerHTML = `<tr><td colspan="${colspan}" class="negative">Failed to load history. Check console for errors.</td></tr>`;
            console.error("Error loading historical data:", error);
        }
    }

    function getBuildupClass(buildup) {
        if (!buildup) return '';
        if (buildup.includes('Long Buildup')) return 'buildup-long';
        if (buildup.includes('Short Buildup')) return 'buildup-short';
        if (buildup.includes('Short Covering')) return 'buildup-short-covering';
        if (buildup.includes('Long Unwinding')) return 'buildup-long-unwinding';
        if (buildup.includes('Fresh OI Added')) return 'buildup-long';
        if (buildup.includes('OI Exited')) return 'buildup-short';
        return '';
    }

    function createPulseCard(symbol) {
        const lower = symbol.toLowerCase();
        const card = document.createElement('div');
        card.className = 'pulse-card';
        card.innerHTML = `
            <h3>${symbol === 'EQUITY' ? 'Equity' : symbol} Pulse</h3>
            <div class="pulse-row"><span>CALLS</span><div class="pulse-bar-container"><div class="pulse-bar calls" id="${lower}-total-call-oi-bar"></div><div class="pulse-bar puts" id="${lower}-total-put-oi-bar"></div></div><span>PUTS</span></div>
            <div class="pulse-labels"><span id="${lower}-total-call-oi-label">-</span><span id="${lower}-total-put-oi-label">-</span></div>
            <h5>Today's Change</h5>
            <div class="pulse-row"><span>CALLS Δ</span><div class="pulse-bar-container"><div class="pulse-bar calls-change" id="${lower}-total-call-coi-bar"></div><div class="pulse-bar puts-change" id="${lower}-total-put-coi-bar"></div></div><span>PUTS Δ</span></div>
            <div class="pulse-labels"><span id="${lower}-total-call-coi-label">-</span><span id="${lower}-total-put-coi-label">-</span></div>
        `;
        return card;
    }

    let latestBhavcopyDataCache = {};

    function updateBhavcopyTables(data, type) {
        console.log("updateBhavcopyTables called with data:", data, "and type:", type);
        if (data && data.date) {
            latestBhavcopyDataCache = data;
            console.log("Bhavcopy data cached for date:", data.date);
        }

        const equityStatusEl = document.getElementById('bhavcopy-equity-status');
        const equityTitleEl = document.getElementById('bhavcopy-equity-title');
        const equityTbody = document.querySelector('#bhavcopy-equity-table tbody');
        const noEquityDataMessage = document.getElementById('no-bhavcopy-equity-data');

        const indicesStatusEl = document.getElementById('bhavcopy-indices-status');
        const indicesTitleEl = document.getElementById('bhavcopy-indices-title');
        const indicesTbody = document.querySelector('#bhavcopy-indices-table tbody');
        const noIndicesDataMessage = document.getElementById('no-bhavcopy-indices-data');

        // Clear existing data and hide no-data messages
        if (equityTbody) equityTbody.innerHTML = '';
        if (indicesTbody) indicesTbody.innerHTML = '';
        if (noEquityDataMessage) noEquityDataMessage.style.display = 'none';
        if (noIndicesDataMessage) noIndicesDataMessage.style.display = 'none';

        if (!type || type === 'equities') {
            console.log("Attempting to update F&O equities table.");
            const targetDateSpan = document.getElementById('bhavcopy-equity-date');
            if (!data || !data.date || !data.fno_data || data.fno_data.length === 0) {
                console.log("No F&O equity data found or error:", data);
                if (targetDateSpan) targetDateSpan.textContent = 'N/A';
                if (equityStatusEl) {
                    equityStatusEl.textContent = data && data.error ? data.error : 'No F&O equity Bhavcopy data available for this date.';
                    equityStatusEl.style.color = '#F44336';
                }
                if (noEquityDataMessage) noEquityDataMessage.style.display = 'block';
            } else {
                console.log("Populating F&O equities table with", data.fno_data.length, "items.");
                if (targetDateSpan) targetDateSpan.textContent = moment(data.date).format('DD MMM YYYY');
                if (equityStatusEl) {
                    equityStatusEl.textContent = 'Latest F&O equity data loaded successfully.';
                    equityStatusEl.style.color = '#4CAF50';
                }
                data.fno_data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.Symbol}</td>
                        <td>${item.Instrument}</td>
                        <td>${item['Expiry Date']}</td>
                        <td>${item['Strike Price'] !== null ? formatNumber(item['Strike Price']) : 'N/A'}</td>
                        <td>${item['Option Type'] !== null ? item['Option Type'] : 'N/A'}</td>
                        <td>${formatNumber(item['Open Interest'], 0)}</td>
                        <td>${formatNumber(item['Change in OI'], 0)}</td>
                        <td>${formatNumber(item.Volume, 0)}</td>
                        <td>${formatNumber(item.Close)}</td>
                        <td>${item['Delivery %'] !== null ? formatNumber(item['Delivery %'], 2) + '%' : 'N/A'}</td>
                    `;
                    if (equityTbody) equityTbody.appendChild(tr);
                });
            }
        }

        if (!type || type === 'indices') {
            console.log("Attempting to update indices table.");
            const targetDateSpan = document.getElementById('bhavcopy-indices-date');
            if (!data || !data.date || !data.indices || data.indices.length === 0) {
                console.log("No index data found or error:", data);
                if (targetDateSpan) targetDateSpan.textContent = 'N/A';
                if (indicesStatusEl) {
                    indicesStatusEl.textContent = data && data.error ? data.error : 'No index Bhavcopy data available for this date.';
                    indicesStatusEl.style.color = '#F44336';
                }
                if (noIndicesDataMessage) noIndicesDataMessage.style.display = 'block';
            } else {
                console.log("Populating indices table with", data.indices.length, "items.");
                if (targetDateSpan) targetDateSpan.textContent = moment(data.date).format('DD MMM YYYY');
                if (indicesStatusEl) {
                    indicesStatusEl.textContent = 'Latest index data loaded successfully.';
                    indicesStatusEl.style.color = '#4CAF50';
                }
                data.indices.forEach(index => {
                    const tr = document.createElement('tr');
                    const changeClass = getChangeColorClass(index['Pct Change']);
                    tr.innerHTML = `
                        <td>${index.Symbol}</td>
                        <td>${formatNumber(index.Close)}</td>
                        <td class="${changeClass}">${formatNumber(index['Pct Change'])}%</td>
                        <td>${formatNumber(index.Open)}</td>
                        <td>${formatNumber(index.High)}</td>
                        <td>${formatNumber(index.Low)}</td>
                    `;
                    if (indicesTbody) indicesTbody.appendChild(tr);
                });
            }
        }
    }

    async function loadBhavcopyHistory(typeToLoad) {
        console.log("loadBhavcopyHistory called for type:", typeToLoad);
        let dateInput, statusEl, tbody, noDataMessage, titleEl, dateSpanId, colCount;
        if (typeToLoad === 'equities') {
            dateInput = document.getElementById('bhavcopy-equity-history-date');
            statusEl = document.getElementById('bhavcopy-equity-status');
            tbody = document.querySelector('#bhavcopy-equity-table tbody');
            noDataMessage = document.getElementById('no-bhavcopy-equity-data');
            titleEl = document.getElementById('bhavcopy-equity-title');
            dateSpanId = 'bhavcopy-equity-date';
            colCount = 10;
        } else if (typeToLoad === 'indices') {
            dateInput = document.getElementById('bhavcopy-indices-history-date');
            statusEl = document.getElementById('bhavcopy-indices-status');
            tbody = document.querySelector('#bhavcopy-indices-table tbody');
            noDataMessage = document.getElementById('no-bhavcopy-indices-data');
            titleEl = document.getElementById('bhavcopy-indices-title');
            dateSpanId = 'bhavcopy-indices-date';
            colCount = 6;
        } else {
            console.error("Invalid type for loadBhavcopyHistory:", typeToLoad);
            return;
        }

        const selectedDate = dateInput.value;
        if (!selectedDate) {
            alert("Please select a date.");
            return;
        }

        if (statusEl) {
            statusEl.textContent = `Loading Bhavcopy for ${selectedDate}...`;
            statusEl.style.color = '#FFC107';
        }
        if (tbody) tbody.innerHTML = `<tr><td colspan="${colCount}">Loading...</td></tr>`;
        if (noDataMessage) noDataMessage.style.display = 'none';

        try {
            const response = await fetch(`/api/bhavcopy/${selectedDate}`);
            const data = await response.json();
            console.log("Received historical Bhavcopy data for", selectedDate, ":", data);

            if (data.error) {
                if (statusEl) {
                    statusEl.textContent = data.error;
                    statusEl.style.color = '#F44336';
                }
                if (tbody) tbody.innerHTML = `<tr><td colspan="${colCount}" class="negative">${data.error}</td></tr>`;
                if (noDataMessage) noDataMessage.style.display = 'block';
                if (titleEl) {
                    const dateSpan = titleEl.querySelector(`#${dateSpanId}`);
                    if (dateSpan) dateSpan.textContent = 'N/A';
                }
            } else {
                updateBhavcopyTables(data, typeToLoad);
                const dateSpan = document.getElementById(dateSpanId);
                if (dateSpan) dateSpan.textContent = moment(data.date).format('DD MMM YYYY');
            }
        } catch (error) {
            if (statusEl) {
                statusEl.textContent = 'Failed to load historical data.';
                statusEl.style.color = '#F44336';
            }
            if (tbody) tbody.innerHTML = `<tr><td colspan="${colCount}" class="negative">Failed to load data.</td></tr>`;
            console.error("Error loading historical bhavcopy:", error);
        }
    }

    async function loadInitialBhavcopyData() {
        console.log("loadInitialBhavcopyData called.");
        try {
            const response = await fetch('/api/bhavcopy');
            const data = await response.json();
            console.log("Received initial Bhavcopy data from /api/bhavcopy:", data);
            updateBhavcopyTables(data); // Call without specific type to update both
        } catch (error) {
            console.error("Error fetching initial Bhavcopy data:", error);
            const equityStatusEl = document.getElementById('bhavcopy-equity-status');
            const indicesStatusEl = document.getElementById('bhavcopy-indices-status');
            if (equityStatusEl) {
                equityStatusEl.textContent = 'Failed to load initial Bhavcopy data.';
                equityStatusEl.style.color = '#F44336';
            }
            if (indicesStatusEl) {
                indicesStatusEl.textContent = 'Failed to load initial Bhavcopy data.';
                indicesStatusEl.style.color = '#F44336';
            }
        }
    }

    async function clearTodaysHistory(symbol) {
        const confirmation = confirm(`Are you sure you want to clear ALL of today's history data for ${symbol || 'all symbols'}? This cannot be undone.`);
        if (confirmation) {
            try {
                const response = await fetch('/clear_todays_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });
                const result = await response.json();
                alert(result.message);
                window.location.reload();
            } catch (error) {
                alert('An error occurred while clearing history.');
                console.error(error);
            }
        }
    }

    async function analyzeBhavcopyStrategies() {
        console.log("analyzeBhavcopyStrategies called.");
        const dateInput = document.getElementById('strategy-bhavcopy-date');
        const selectedDate = dateInput.value;
        if (!selectedDate) {
            alert("Please select a date for Bhavcopy analysis.");
            return;
        }

        const strategyStatusEl = document.getElementById('strategy-status');
        if (strategyStatusEl) {
            strategyStatusEl.textContent = `Initiating Bhavcopy download and strategy analysis for ${selectedDate}...`;
            strategyStatusEl.style.color = '#FFC107';
        }

        document.querySelectorAll('#strategy-results-container table tbody').forEach(tbody => {
            const colspan = tbody.previousElementSibling.querySelector('thead tr').children.length;
            tbody.innerHTML = `<tr><td colspan="${colspan}">Loading...</td></tr>`;
        });

        socket.emit('run_bhavcopy_for_date_and_analyze', { date: selectedDate });
    }

    socket.on('bhavcopy_analysis_status', (data) => {
        const strategyStatusEl = document.getElementById('strategy-status');
        if (strategyStatusEl) {
            strategyStatusEl.textContent = data.message;
            strategyStatusEl.style.color = data.success ? '#4CAF50' : '#F44336';
        }
        if (!data.success) {
            document.querySelectorAll('#strategy-results-container table tbody').forEach(tbody => {
                const colspan = tbody.previousElementSibling.querySelector('thead tr').children.length;
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="negative">${data.message}</td></tr>`;
            });
        }
    });

    socket.on('bhavcopy_strategy_results', (data) => {
        console.log("Received bhavcopy_strategy_results:", data);
        const results = data.results;
        const selectedDate = data.date;

        populateFddtTable(results.FDDT);
        populateZdftTable(results.ZDFT);
        populateBdgpTable(results.BDGP);
        populateVar7Table(results.VAR7);
        populateHba21Table(results.HBA21);
        populateOimtTable(results.OIMT);
        populateVssbTable(results.VSSB);
        populateOoadTable(results.OOAD);
        populateCaadtTable(results.CAADT);
    });

    function populateFddtTable(data) {
        const tbody = document.querySelector('#strategy-fddt-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("Requires"))) {
            tbody.innerHTML = `<tr><td colspan="2">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available. (Requires FII/DII data integration)'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateZdftTable(data) {
        const tbody = document.querySelector('#strategy-zdft-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("No Zero-Delivery"))) {
            tbody.innerHTML = `<tr><td colspan="4">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available.'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item['Near Month Delivery %']}</td><td>${item['Next Month OI Increase %']}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateBdgpTable(data) {
        const tbody = document.querySelector('#strategy-bdgp-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("No Equity or Block Deal"))) {
            tbody.innerHTML = `<tr><td colspan="7">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available.'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item['Block Deal Price']}</td><td>${item['Previous Close']}</td><td>${item['Open Price']}</td><td>${item['Block Discount %']}</td><td>${item['Open Gap Up %']}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateVar7Table(data) {
        const tbody = document.querySelector('#strategy-var7-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("No Equity data"))) {
            tbody.innerHTML = `<tr><td colspan="6">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available.'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item['Close Price']}</td><td>${item.VWAP}</td><td>${item['Close vs VWAP %']}</td><td>${item['Delivery %']}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateHba21Table(data) {
        const tbody = document.querySelector('#strategy-hba21-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("Requires Corporate Actions"))) {
            tbody.innerHTML = `<tr><td colspan="2">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available. (Requires Corporate Actions data and multi-day delivery trend analysis)'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateOimtTable(data) {
        const tbody = document.querySelector('#strategy-oimt-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("No Equity or F&O"))) {
            tbody.innerHTML = `<tr><td colspan="5">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available.'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item['Price Change %']}</td><td>${item['OI Change']}</td><td>${item['Signal Type']}</td><td>${item['Institutional Conviction (Delivery > 60%)']}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateVssbTable(data) {
        const tbody = document.querySelector('#strategy-vssb-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("No Equity data"))) {
            tbody.innerHTML = `<tr><td colspan="7">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available.'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item["Today's Volume"]}</td><td>${item['10-Day Avg Volume']}</td><td>${item['Volume Multiple']}</td><td>${item['Delivery %']}</td><td>${item['Price Change %']}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateOoadTable(data) {
        const tbody = document.querySelector('#strategy-ooad-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("Requires detailed Options"))) {
            tbody.innerHTML = `<tr><td colspan="2">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available. (Requires detailed Options Bhavcopy parsing and storage)'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateCaadtTable(data) {
        const tbody = document.querySelector('#strategy-caadt-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!data || data.length === 0 || (data.length === 1 && data[0].Signal && data[0].Signal.includes("Requires Corporate Actions"))) {
            tbody.innerHTML = `<tr><td colspan="2">${data && data.length > 0 && data[0].Signal ? data[0].Signal : 'No data available. (Requires Corporate Actions data and multi-day delivery trend analysis)'}</td></tr>`;
            return;
        }
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.Symbol}</td><td>${item.Signal}</td>`;
            tbody.appendChild(tr);
        });
    }

    let news_alerts = [];

    function renderNewsTable(newsData) {
        const newsTbody = document.querySelector('#news-table tbody');
        if (!newsTbody) return;
        newsTbody.innerHTML = '';
        if (!newsData || newsData.length === 0) {
            newsTbody.innerHTML = `<tr><td colspan="6">No news available.</td></tr>`;
            const newsStatusEl = document.getElementById('news-status');
            if (newsStatusEl) {
                newsStatusEl.textContent = 'No news available.';
                newsStatusEl.style.color = '';
            }
            return;
        }

        newsData.forEach(newsItem => {
            const tr = document.createElement('tr');
            const formattedTime = moment.tz(newsItem.timestamp, 'Asia/Kolkata').format('HH:mm');
            const impactClass = newsItem.Impact && newsItem.Impact.includes('Bullish') ? 'positive' : (newsItem.Impact && newsItem.Impact.includes('Bearish') ? 'negative' : 'neutral');
            tr.innerHTML = `
                <td>${formattedTime}</td>
                <td>${newsItem.Headline}</td>
                <td>${newsItem.Source}</td>
                <td>${newsItem['Key Details'] || 'N/A'}</td>
                <td class="${impactClass}">${newsItem.Impact || 'N/A'}</td>
                <td><a href="${newsItem.URL}" target="_blank">Link</a></td>
            `;
            newsTbody.appendChild(tr);
        });
        const newsStatusEl = document.getElementById('news-status');
        if (newsStatusEl) {
            newsStatusEl.textContent = 'Latest news fetched.';
            newsStatusEl.style.color = '#4CAF50';
        }
    }

    // NEW: Function to render live OI summaries
    function renderLiveOiSummaries(oiSummariesData) {
        const container = document.getElementById('live-oi-summaries-container');
        if (!container) return;
        container.innerHTML = ''; // Clear previous content

        if (!oiSummariesData || Object.keys(oiSummariesData).length === 0) {
            container.innerHTML = `<p style="text-align: center;">No live OI summary data available.</p>`;
            return;
        }

        // Iterate over each symbol in the OI summaries data
        for (const symbol in oiSummariesData) {
            const symbolData = oiSummariesData[symbol];
            if (Object.keys(symbolData).length === 0) continue; // Skip if no data for symbol

            const symbolDiv = document.createElement('div');
            symbolDiv.className = 'oi-summary-symbol-card';
            symbolDiv.innerHTML = `<h4>${symbol}</h4>`;

            const table = document.createElement('table');
            table.className = 'oi-summary-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Interval</th>
                        <th>Type</th>
                        <th>Strike</th>
                        <th>OI Change</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            // Timeframes to display
            const timeframes = ['15min', '30min', '60min'];

            timeframes.forEach(tf => {
                const tfData = symbolData[tf];
                if (tfData && tfData.length > 0) {
                    tfData.forEach(item => {
                        const tr = document.createElement('tr');
                        const statusClass = item.status.includes('Long Buildup') || item.status.includes('Fresh OI Added') ? 'positive' :
                                            (item.status.includes('Short Buildup') || item.status.includes('OI Exited') ? 'negative' : 'neutral');
                        tr.innerHTML = `
                            <td>${item.interval}</td>
                            <td>${item.type}</td>
                            <td>${item.strike !== 'N/A' ? formatNumber(item.strike, 0) : 'N/A'}</td>
                            <td class="${statusClass}">${item.oi_change !== 'N/A' ? formatNumber(item.oi_change, 0) : 'N/A'}</td>
                            <td class="${statusClass}">${item.status}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    // Add a row indicating no data for this timeframe
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${tf}</td>
                        <td colspan="4">No significant shifts</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            symbolDiv.appendChild(table);
            container.appendChild(symbolDiv);
        }
    }

    // NEW: Function to render historical OI first/last hour summaries
    function renderHistoricalOiSummaries(historicalData) {
        const container = document.getElementById('historical-oi-summaries-container');
        if (!container) return;
        container.innerHTML = ''; // Clear previous content

        if (!historicalData || Object.keys(historicalData).length === 0) {
            container.innerHTML = `<p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;">No historical OI summary data found for the selected date and symbol.</p>`;
            return;
        }

        // historicalData is structured as {date: {symbol: {type: summary_list}}}
        for (const date in historicalData) {
            const dateData = historicalData[date];
            for (const symbol in dateData) {
                const symbolData = dateData[symbol];
                if (Object.keys(symbolData).length === 0) continue;

                const symbolDateDiv = document.createElement('div');
                symbolDateDiv.className = 'oi-summary-symbol-card';
                symbolDateDiv.innerHTML = `<h4>${symbol} - ${moment(date).format('DD MMM YYYY')}</h4>`;

                const table = document.createElement('table');
                table.className = 'oi-summary-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Interval</th>
                            <th>Strike</th>
                            <th>OI Change</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                const types = ['TODAY_FIRST_15', 'TODAY_FIRST_30', 'TODAY_FIRST_60', 'TOMORROW_LAST_15', 'TOMORROW_LAST_30', 'TOMORROW_LAST_60'];

                types.forEach(typeKey => {
                    const summaryList = symbolData[typeKey]; // Access the array directly
                    if (summaryList && summaryList.length > 0) {
                        summaryList.forEach(item => {
                            const tr = document.createElement('tr');
                            const statusClass = item.status.includes('Long Buildup') || item.status.includes('Fresh OI Added') ? 'positive' :
                                                (item.status.includes('Short Buildup') || item.status.includes('OI Exited') ? 'negative' : 'neutral');
                            tr.innerHTML = `
                                <td>${typeKey.replace(/_/g, ' ').replace('TODAY FIRST', 'Today\'s First').replace('TOMORROW LAST', 'Tomorrow\'s Last')}</td>
                                <td>${item.interval}</td>
                                <td>${item.strike !== 'N/A' ? formatNumber(item.strike, 0) : 'N/A'}</td>
                                <td class="${statusClass}">${item.oi_change !== 'N/A' ? formatNumber(item.oi_change, 0) : 'N/A'}</td>
                                <td class="${statusClass}">${item.status}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                         const tr = document.createElement('tr');
                         tr.innerHTML = `
                             <td>${typeKey.replace(/_/g, ' ').replace('TODAY FIRST', 'Today\'s First').replace('TOMORROW LAST', 'Tomorrow\'s Last')}</td>
                             <td colspan="4">No significant shifts</td>
                         `;
                         tbody.appendChild(tr);
                    }
                });
                symbolDateDiv.appendChild(table);
                container.appendChild(symbolDateDiv);
            }
        }
    }

    async function loadOiSummaryHistory() {
        const symbolSelector = document.getElementById('oi-summary-history-symbol-selector');
        const dateInput = document.getElementById('oi-summary-history-date');
        const selectedSymbol = symbolSelector ? symbolSelector.value : null;
        const selectedDate = dateInput ? dateInput.value : null;

        const statusEl = document.getElementById('historical-oi-summary-status');
        const container = document.getElementById('historical-oi-summaries-container');

        if (!selectedSymbol || !selectedDate) {
            if (statusEl) {
                statusEl.textContent = "Please select both a symbol and a date.";
                statusEl.style.color = '#F44336';
            }
            if (container) container.innerHTML = `<p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;">Select a symbol and date to view historical OI summaries.</p>`;
            return;
        }

        if (statusEl) {
            statusEl.textContent = `Loading historical OI summaries for ${selectedSymbol} on ${selectedDate}...`;
            statusEl.style.color = '#FFC107';
        }
        if (container) container.innerHTML = `<p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;">Loading...</p>`; // Placeholder for loading

        try {
            const response = await fetch(`/api/oi_summary_history/${selectedSymbol}/${selectedDate}`);
            const data = await response.json();

            if (data.error) {
                if (statusEl) {
                    statusEl.textContent = data.error;
                    statusEl.style.color = '#F44336';
                }
                if (container) container.innerHTML = `<p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;" class="negative">${data.error}</p>`;
            } else {
                if (statusEl) {
                    statusEl.textContent = `Historical OI summaries for ${selectedSymbol} on ${selectedDate} loaded successfully.`;
                    statusEl.style.color = '#4CAF50';
                }
                renderHistoricalOiSummaries(data);
            }
        } catch (error) {
            if (statusEl) {
                statusEl.textContent = 'Failed to load historical OI summaries.';
                statusEl.style.color = '#F44336';
            }
            if (container) container.innerHTML = `<p id="historical-oi-summary-status" style="text-align: center; margin-bottom: 20px;" class="negative">Failed to load historical OI summaries. Check console for errors.</p>`;
            console.error("Error loading historical OI summaries:", error);
        }
    }


    socket.on('initial_todays_history', (data) => {
        console.log("Received initial_todays_history:", data);
        if (!data.history) return;
        Object.keys(data.history).forEach(sym => {
            const historyTbody = document.querySelector(`#${sym.toLowerCase()}-todays-history-table tbody`);
            if (historyTbody) {
                historyTbody.innerHTML = '';
                // Sorting by time in ascending order for initial load to ensure correct order
                const sortedHistory = data.history[sym].sort((a, b) => {
                    // Assuming item.time is in "HH:MM" format
                    const timeA = moment(a.time, "HH:mm");
                    const timeB = moment(b.time, "HH:mm");
                    return timeA.diff(timeB);
                });
                sortedHistory.forEach(item => addHistoryItemToTable(historyTbody, item, sym, false));
            }
        });
    });

    socket.on('todays_history_append', (data) => {
        console.log("Received todays_history_append:", data);
        if (data.symbol && data.item) {
            const historyTbody = document.querySelector(`#${data.symbol.toLowerCase()}-todays-history-table tbody`);
            if (historyTbody) addHistoryItemToTable(historyTbody, data.item, data.symbol, true);
        }
    });

    socket.on('update_visits', (data) => {
        console.log("Received update_visits:", data);
        const visitCounter = document.getElementById('visit-counter');
        if (visitCounter) visitCounter.textContent = data.count;
    });

    socket.on('top_movers_update', (data) => {
        console.log("Received top_movers_update:", data);
        const strongestTbody = document.querySelector('#top-strongest-table tbody');
        const weakestTbody = document.querySelector('#top-weakest-table tbody');
        const improvingTbody = document.querySelector('#top-improving-table tbody');
        const worseningTbody = document.querySelector('#top-worsening-table tbody');

        [strongestTbody, weakestTbody, improvingTbody, worseningTbody].forEach(tbody => {
            if (tbody) tbody.innerHTML = '';
        });

        data.strongest.forEach((stock, index) => {
            if (!strongestTbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${formatNumber(stock.score)}</td><td class="${stock.sentiment.includes('Bullish') ? 'positive' : (stock.sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${stock.sentiment}</td><td>${formatNumber(stock.pcr)}</td>`;
            strongestTbody.appendChild(tr);
        });
        data.weakest.forEach((stock, index) => {
            if (!weakestTbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${formatNumber(stock.score)}</td><td class="${stock.sentiment.includes('Bullish') ? 'positive' : (stock.sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${stock.sentiment}</td><td>${formatNumber(stock.pcr)}</td>`;
            weakestTbody.appendChild(tr);
        });
        data.improving.forEach((stock, index) => {
            if (!improvingTbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${formatNumber(stock.score)}</td><td class="${stock.sentiment.includes('Bullish') ? 'positive' : (stock.sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${stock.sentiment}</td><td>${formatNumber(stock.pcr)}</td>`;
            improvingTbody.appendChild(tr);
        });
        data.worsening.forEach((stock, index) => {
            if (!worseningTbody) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${formatNumber(stock.score)}</td><td class="${stock.sentiment.includes('Bullish') ? 'positive' : (stock.sentiment.includes('Bearish') ? 'negative' : 'neutral')}">${stock.sentiment}</td><td>${formatNumber(stock.pcr)}</td>`;
            worseningTbody.appendChild(tr);
        });
    });

    socket.on('bhavcopy_update', (data) => {
        console.log("Received live Bhavcopy update via WebSocket:", data);
        updateBhavcopyTables(data);
    });

    socket.on('update', (data) => {
        console.log("Received live 'update' data:", data);
        const timeElement = document.getElementById('time');
        if (timeElement) timeElement.textContent = new Date().toLocaleTimeString();

        // Update ticker for ALL_SYMBOLS
        ALL_SYMBOLS.forEach(sym => {
            const lower = sym.toLowerCase().replace(/-/g, '');
            let tickerValue = '-';
            let tickerChange = '-';
            let tickerChangeClass = 'neutral';

            // Prioritize live_feed_summary for YFinance assets (which have 'change' and 'percentage_change')
            if (YF_ASSETS.includes(sym) && data.live_feed_summary && data.live_feed_summary[sym]) {
                const feed = data.live_feed_summary[sym];
                if (typeof feed.current_value !== 'undefined' && feed.current_value !== null) {
                    tickerValue = formatNumber(feed.current_value, 4);
                    const changeValue = parseFloat(feed.change);
                    const pctChangeValue = parseFloat(feed.percentage_change);
                    tickerChange = `${changeValue >= 0 ? '▲' : '▼'} ${Math.abs(changeValue).toFixed(2)} (${pctChangeValue.toFixed(2)}%)`;
                    tickerChangeClass = getChangeColorClass(changeValue);
                }
            }
            // For OI_SYMBOLS (NIFTY, FINNIFTY, BANKNIFTY) use data.live[sym].summary
            else if (OI_SYMBOLS.includes(sym) && data.live && data.live[sym] && data.live[sym].summary) {
                const summary = data.live[sym].summary;
                if (typeof summary.value !== 'undefined' && summary.value !== null) {
                    tickerValue = formatNumber(summary.value, 2); // Assuming value is the main price
                    // Calculate change and percentage change from current and previous value if available
                    // This assumes `shared_data_cache` has the previous value, or `summary` itself has it.
                    // For now, let's just show value and PCR in ticker for now if change not directly available
                    // Or, we need to store previous 'value' in shared_data_cache to calculate change
                    // For now, let's use a simple representation.
                    tickerChange = `PCR: ${formatNumber(summary.pcr)}`; // Show PCR in change spot
                    tickerChangeClass = getChangeColorClass(summary.pcr - 1); // Simple color based on PCR vs 1
                }
            }

            // Update the elements
            const valEl = document.getElementById(`ticker-${lower}-value`);
            const chgEl = document.getElementById(`ticker-${lower}-change`);
            const valElClone = document.getElementById(`ticker-${lower}-value-clone`);
            const chgElClone = document.getElementById(`ticker-${lower}-change-clone`);

            if (valEl) valEl.textContent = tickerValue;
            if (chgEl) {
                chgEl.textContent = tickerChange;
                chgEl.classList.remove('positive', 'negative', 'neutral');
                chgEl.classList.add(tickerChangeClass);
            }
            if (valElClone) valElClone.textContent = tickerValue;
            if (chgElClone) {
                chgElClone.textContent = tickerChange;
                chgElClone.classList.remove('positive', 'negative', 'neutral');
                chgElClone.classList.add(tickerChangeClass);
            }
        });


        if (data.live) {
            OI_SYMBOLS.forEach(sym => {
                const liveData = data.live[sym];
                if (!liveData || !liveData.pulse_summary) return;
                const lower = sym.toLowerCase();
                const s = liveData.pulse_summary;

                // FIX: Check for existence of elements before accessing
                const callOiBar = document.getElementById(`${lower}-total-call-oi-bar`);
                const putOiBar = document.getElementById(`${lower}-total-put-oi-bar`);
                const callOiLabel = document.getElementById(`${lower}-total-call-oi-label`);
                const putOiLabel = document.getElementById(`${lower}-total-put-oi-label`);

                if (callOiBar && putOiBar && callOiLabel && putOiLabel) {
                    const totalOI = s.total_call_oi + s.total_put_oi; // These are total OI, not COI
                    const callOIPct = totalOI > 0 ? (s.total_call_oi / totalOI * 100) : 50;
                    callOiBar.style.width = `${callOIPct}%`;
                    putOiBar.style.width = `${100 - callOIPct}%`;
                    callOiLabel.textContent = formatNumber(s.total_call_oi, 0);
                    putOiLabel.textContent = formatNumber(s.total_put_oi, 0);
                }


                // Using total_call_coi and total_put_coi from pulse_summary for daily change
                const callCoiBar = document.getElementById(`${lower}-total-call-coi-bar`);
                const putCoiBar = document.getElementById(`${lower}-total-put-coi-bar`);
                const callCoiLabel = document.getElementById(`${lower}-total-call-coi-label`);
                const putCoiLabel = document.getElementById(`${lower}-total-put-coi-label`);

                if (callCoiBar && putCoiBar && callCoiLabel && putCoiLabel) {
                    const totalCOI = Math.abs(s.total_call_coi) + Math.abs(s.total_put_coi);
                    const callCOIPct = totalCOI > 0 ? (Math.abs(s.total_call_coi) / totalCOI * 100) : 50;
                    callCoiBar.style.width = `${callCOIPct}%`;
                    putCoiBar.style.width = `${100 - callCOIPct}%`;
                    callCoiLabel.textContent = formatNumber(s.total_call_coi, 0);
                    putCoiLabel.textContent = formatNumber(s.total_put_coi, 0);
                }
            });

            // This is the key change: Always update charts for the active symbol
            const activeTabElement = document.querySelector('.tablink.active');
            if (activeTabElement) {
                const activeSymbol = activeTabElement.dataset.symbol;
                // Only update charts if the active tab is an OI_SYMBOL or EQUITY and has live data
                if ((OI_SYMBOLS.includes(activeSymbol) || activeSymbol === "EQUITY")) {
                    const currentEquitySymbol = activeSymbol === "EQUITY" ? $('#equity-symbol-selector').val() : activeSymbol;
                    if (currentEquitySymbol && data.live[currentEquitySymbol]) {
                         // Cache the live data for the active symbol
                        shared_data_cache[currentEquitySymbol] = data.live[currentEquitySymbol];
                        updateCharts(currentEquitySymbol, data.live[currentEquitySymbol]);
                        // Also update the summary card for the selected equity
                        if (activeSymbol === "EQUITY") {
                            updateEquitySummaryCard(currentEquitySymbol, data.live[currentEquitySymbol]);
                        }
                    }
                }
            }

            Object.keys(data.live).forEach(sym => {
                const lower = sym.toLowerCase();
                const liveData = data.live[sym];

                if (liveData.summary) {
                    const summaryCard = document.getElementById(`${sym}_summary`);
                    if (summaryCard) {
                         // FIX: Add null checks for elements
                         if(document.getElementById(`${lower}-sp`)) document.getElementById(`${lower}-sp`).textContent = formatNumber(liveData.summary.sp, 0);
                         const valueEl = summaryCard.querySelector(`#${lower}-value`);
                         if(valueEl) valueEl.textContent = formatNumber(liveData.summary.value);
                         // MODIFIED: Update to use new call_coi_daily/put_coi_daily keys
                         if(document.getElementById(`${lower}-call-coi-daily`)) document.getElementById(`${lower}-call-coi-daily`).textContent = formatNumber(liveData.summary.call_coi_daily, 1) + 'K';
                         if(document.getElementById(`${lower}-put-coi-daily`)) document.getElementById(`${lower}-put-coi-daily`).textContent = formatNumber(liveData.summary.put_coi_daily, 1) + 'K';
                         // NEW: Update diff_oi_daily
                         const diffOiEl = document.getElementById(`${lower}-diff-oi-daily`);
                         if(diffOiEl) {
                             diffOiEl.textContent = formatNumber(liveData.summary.diff_oi_daily, 0);
                             diffOiEl.classList.remove('positive', 'negative', 'neutral');
                             diffOiEl.classList.add(getChangeColorClass(liveData.summary.diff_oi_daily));
                         }
                         if(document.getElementById(`${lower}-pcr`)) document.getElementById(`${lower}-pcr`).textContent = formatNumber(liveData.summary.pcr);
                         const sentimentEl = document.getElementById(`${lower}-sentiment`);
                         if(sentimentEl) {
                             sentimentEl.textContent = liveData.summary.sentiment;
                             sentimentEl.classList.remove('positive', 'negative', 'neutral');
                             sentimentEl.classList.add(liveData.summary.sentiment.includes('Bullish') ? 'positive' : (liveData.summary.sentiment.includes('Bearish') ? 'negative' : 'neutral'));
                         }
                         const mlSentimentEl = document.getElementById(`${lower}-ml-sentiment`);
                         if(mlSentimentEl) {
                            mlSentimentEl.textContent = liveData.summary.ml_sentiment;
                            mlSentimentEl.classList.remove('positive', 'negative', 'neutral');
                            mlSentimentEl.classList.add(liveData.summary.ml_sentiment && liveData.summary.ml_sentiment.includes('Bullish') ? 'positive' : (liveData.summary.ml_sentiment && liveData.summary.ml_sentiment.includes('Bearish') ? 'negative' : 'neutral'));
                         }
                         const sentimentReasonEl = document.getElementById(`${lower}-sentiment-reason`);
                         if(sentimentReasonEl) {
                            sentimentReasonEl.textContent = liveData.summary.sentiment_reason || 'N/A';
                         }
                         if(document.getElementById(`${lower}-add-exit`)) document.getElementById(`${lower}-add-exit`).textContent = liveData.summary.add_exit;
                         const changeEl = summaryCard.querySelector(`#${lower}-change`);
                         if(changeEl) {
                             changeEl.textContent = liveData.summary.change >= 0 ? `+${formatNumber(liveData.summary.change)}` : formatNumber(liveData.summary.change);
                             changeEl.classList.remove('positive', 'negative', 'neutral');
                             changeEl.classList.add(getChangeColorClass(liveData.summary.change));
                         }
                         const pctEl = summaryCard.querySelector(`#${lower}-pct`);
                         if(pctEl) {
                             pctEl.textContent = `${formatNumber(liveData.summary.percentage_change)}%`;
                             pctEl.classList.remove('positive', 'negative', 'neutral');
                             pctEl.classList.add(getChangeColorClass(liveData.summary.percentage_change));
                         }
                    }
                }
                if (OI_SYMBOLS.includes(sym) && liveData.strikes) {
                    const tbody = document.querySelector(`#${lower}-table tbody`);
                    if(tbody) {
                        tbody.innerHTML = '';
                        liveData.strikes.forEach(row => {
                            const tr = document.createElement('tr');
                            if (row.is_atm) tr.classList.add('atm-strike');
                            tr.innerHTML = `
                                <td class="${getBuildupClass(row.call_buildup)}">${row.call_buildup}</td>
                                <td>${row.strike}</td>
                                <td>${formatNumber(row.call_oi, 0)}</td>
                                <td class="${getChangeColorClass(row.call_coi)}">${formatNumber(row.call_coi, 0)}</td>
                                <td class="action-cell">${row.call_action}</td>
                                <td>${formatNumber(row.put_oi, 0)}</td>
                                <td class="${getChangeColorClass(row.put_coi)}">${formatNumber(row.put_coi, 0)}</td>
                                <td class="action-cell">${row.put_action}</td>
                                <td class="${getBuildupClass(row.put_buildup)}">${row.put_buildup}</td>`;
                            tbody.appendChild(tr);
                        });
                    }
                }
                shared_data_cache[sym] = liveData; // Always update cache for all symbols
            });
        }

        if (data.ai_bot_trade_history) {
            const aiBotTradesTbody = document.querySelector('#ai-bot-trades-table tbody');
            if (aiBotTradesTbody) {
                aiBotTradesTbody.innerHTML = '';
                let latestRationale = {};

                const sortedHistory = data.ai_bot_trade_history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                sortedHistory.forEach(trade => {
                    const tr = document.createElement('tr');
                    const recClass = trade.recommendation === "BUY" ? "positive" : (trade.recommendation === "SELL" ? "negative" : (trade.status === "Exit" ? "neutral" : "neutral"));
                    const pnlClass = getPnLClass(trade.pnl);

                    tr.innerHTML = `
                        <td>${moment.tz(trade.timestamp, 'Asia/Kolkata').format('HH:mm:ss')}</td>
                        <td>${trade.symbol}</td>
                        <td class="${trade.status === "Entry" ? "positive" : (trade.status === "Exit" ? "negative" : "neutral")}">${trade.status}</td>
                        <td class="${pnlClass}">${trade.pnl !== 0.0 ? formatNumber(trade.pnl) : '-'}</td>
                        <td>${trade.action_price !== 0.0 ? formatNumber(trade.action_price) : '-'}</td>
                        <td class="${recClass}">${trade.trade}</td>
                        <td>${trade.strikes}</td>
                        <td>${trade.type}</td>
                        <td>${trade.risk_pct}</td>
                        <td>${trade.exit_rule}</td>
                    `;
                    aiBotTradesTbody.appendChild(tr);

                    if (!latestRationale[trade.symbol]) {
                        latestRationale[trade.symbol] = trade.rationale;
                    }
                });


                let combinedRationaleText = '';
                Object.keys(latestRationale).sort().forEach(sym => {
                    combinedRationaleText += `<b>${sym}:</b> ${latestRationale[sym]}<br>`;
                });
                const aiBotRationaleEl = document.getElementById('ai-bot-rationale');
                if (aiBotRationaleEl) aiBotRationaleEl.innerHTML = combinedRationaleText;


                if (aiBotTradesTbody.children.length === 0) {
                    aiBotTradesTbody.innerHTML = `<tr><td colspan="10">Waiting for AI Bot recommendations...</td></tr>`;
                    if (aiBotRationaleEl) aiBotRationaleEl.innerHTML = 'No active recommendations.';
                }
            }
        }
        // NEW: Update live OI summaries
        if (data.oi_change_summaries) {
            renderLiveOiSummaries(data.oi_change_summaries);
        }
    });

    // New function to update the Equity summary card specifically
    function updateEquitySummaryCard(symbol, liveData) {
        const lower = symbol.toLowerCase();
        const summary = liveData.summary;
        if (!summary) return;

        // FIX: Add null checks for elements
        const spEl = document.getElementById('equity-sp');
        if(spEl) spEl.textContent = formatNumber(summary.sp, 0);

        const valueEl = document.getElementById('equity-value');
        if(valueEl) valueEl.textContent = formatNumber(summary.value);

        const callCoiDailyEl = document.getElementById('equity-call-coi-daily');
        if(callCoiDailyEl) callCoiDailyEl.textContent = formatNumber(summary.call_coi_daily, 1) + 'K';

        const putCoiDailyEl = document.getElementById('equity-put-coi-daily');
        if(putCoiDailyEl) putCoiDailyEl.textContent = formatNumber(summary.put_coi_daily, 1) + 'K';

        const diffOiDailyEl = document.getElementById('equity-diff-oi-daily');
        if(diffOiDailyEl) {
            diffOiDailyEl.textContent = formatNumber(summary.diff_oi_daily, 0);
            diffOiDailyEl.classList.remove('positive', 'negative', 'neutral');
            diffOiDailyEl.classList.add(getChangeColorClass(summary.diff_oi_daily));
        }

        const pcrEl = document.getElementById('equity-pcr');
        if(pcrEl) pcrEl.textContent = formatNumber(summary.pcr);

        const intradayPcrValueEl = document.getElementById('equity-intraday-pcr-value');
        if(intradayPcrValueEl) intradayPcrValueEl.textContent = formatNumber(summary.intraday_pcr);

        const sentimentEl = document.getElementById('equity-sentiment');
        if(sentimentEl) {
            sentimentEl.textContent = summary.sentiment;
            sentimentEl.classList.remove('positive', 'negative', 'neutral');
            sentimentEl.classList.add(summary.sentiment.includes('Bullish') ? 'positive' : (summary.sentiment.includes('Bearish') ? 'negative' : 'neutral'));
        }

        const mlSentimentEl = document.getElementById('equity-ml-sentiment');
        if(mlSentimentEl) {
            mlSentimentEl.textContent = summary.ml_sentiment;
            mlSentimentEl.classList.remove('positive', 'negative', 'neutral');
            mlSentimentEl.classList.add(summary.ml_sentiment && summary.ml_sentiment.includes('Bullish') ? 'positive' : (summary.ml_sentiment && summary.ml_sentiment.includes('Bearish') ? 'negative' : 'neutral'));
        }

        const sentimentReasonEl = document.getElementById('equity-sentiment-reason');
        if(sentimentReasonEl) sentimentReasonEl.textContent = summary.sentiment_reason || 'N/A';
    }


    socket.on('equity_data_update', (response) => {
        console.log("Received equity_data_update:", response);
        const equityLoader = document.getElementById('equity-loader');
        const dataContainer = document.getElementById('equity-data-container');
        const errorContainer = document.getElementById('equity-error');

        if (equityLoader) equityLoader.classList.add('hidden');

        if (response.error) {
            if (errorContainer) {
                errorContainer.textContent = `Error fetching data for ${response.symbol}: ${response.error}`;
                errorContainer.classList.remove('hidden');
            }
            if (dataContainer) dataContainer.classList.add('hidden');
            return;
        }

        if (errorContainer) errorContainer.classList.add('hidden');
        if (dataContainer) dataContainer.classList.remove('hidden');

        const equityData = response.data;
        const symbol = response.symbol;
        const equityTitleEl = document.getElementById('equity-title');
        if (equityTitleEl) equityTitleEl.textContent = `${symbol} Option Chain Analysis`;

        const pulseContainer = document.getElementById('equity-market-pulse-container');
        if (pulseContainer && !document.getElementById('equity_pulse_card')) {
            const pulseCard = createPulseCard('EQUITY');
            pulseCard.id = 'equity_pulse_card';
            pulseContainer.innerHTML = '';
            pulseContainer.appendChild(pulseCard);
        }
        const pulseSummary = equityData.pulse_summary;

        // FIX: Check for existence of elements before accessing
        const callOiBar = document.getElementById('equity-total-call-oi-bar');
        const putOiBar = document.getElementById('equity-total-put-oi-bar');
        const callOiLabel = document.getElementById('equity-total-call-oi-label');
        const putOiLabel = document.getElementById('equity-total-put-oi-label');

        if (pulseSummary && callOiBar && putOiBar && callOiLabel && putOiLabel) {
            const totalOI = pulseSummary.total_call_oi + pulseSummary.total_put_oi; // These are total OI, not COI
            const callOIPct = totalOI > 0 ? (pulseSummary.total_call_oi / totalOI * 100) : 50;
            callOiBar.style.width = `${callOIPct}%`;
            putOiBar.style.width = `${100 - callOIPct}%`;
            callOiLabel.textContent = formatNumber(pulseSummary.total_call_oi, 0);
            putOiLabel.textContent = formatNumber(pulseSummary.total_put_oi, 0);
        }

        // Using total_call_coi and total_put_coi from pulse_summary for daily change
        const callCoiBar = document.getElementById('equity-total-call-coi-bar');
        const putCoiBar = document.getElementById('equity-total-put-coi-bar');
        const callCoiLabel = document.getElementById('equity-total-call-coi-label');
        const putCoiLabel = document.getElementById('equity-total-put-coi-label');

        if (pulseSummary && callCoiBar && putCoiBar && callCoiLabel && putCoiLabel) {
            const totalCOI = Math.abs(pulseSummary.total_call_coi) + Math.abs(pulseSummary.total_put_coi);
            const callCOIPct = totalCOI > 0 ? (Math.abs(pulseSummary.total_call_coi) / totalCOI * 100) : 50;
            callCoiBar.style.width = `${callCOIPct}%`;
            putCoiBar.style.width = `${100 - callCOIPct}%`;
            callCoiLabel.textContent = formatNumber(pulseSummary.total_call_coi, 0);
            putCoiLabel.textContent = formatNumber(pulseSummary.total_put_coi, 0);
        }

        updateEquitySummaryCard(symbol, equityData); // Update the summary card

        const tableBody = document.querySelector('#equity-table tbody');
        if (tableBody) { // FIX: Add null check for tableBody
            tableBody.innerHTML = '';
            equityData.strikes.forEach(row => {
                const tr = document.createElement('tr');
                if (row.is_atm) tr.classList.add('atm-strike');
                tr.innerHTML = `
                    <td class="${getBuildupClass(row.call_buildup)}">${row.call_buildup}</td>
                    <td>${row.strike}</td>
                    <td>${formatNumber(row.call_oi, 0)}</td>
                    <td class="${getChangeColorClass(row.call_coi)}">${formatNumber(row.call_coi, 0)}</td>
                    <td class="action-cell">${row.call_action}</td>
                    <td>${formatNumber(row.put_oi, 0)}</td>
                    <td class="${getChangeColorClass(row.put_coi)}">${formatNumber(row.put_coi, 0)}</td>
                    <td class="action-cell">${row.put_action}</td>
                    <td class="${getBuildupClass(row.put_buildup)}">${row.put_buildup}</td>`;
                tableBody.appendChild(tr);
            });
        }

        updateCharts(symbol, equityData);
    });

    socket.on('news_update', (data) => {
        console.log("Received news_update:", data);
        if (data.news) {
            news_alerts = data.news;
            const newsTabContent = document.getElementById('NEWS_tab');
            if (newsTabContent && newsTabContent.style.display === 'block') {
                renderNewsTable(news_alerts);
            }
        }
    });

    socket.on('first_last_oi_summaries', (data) => {
        console.log("Received first_last_oi_summaries:", data);
        // This event is for initial connection. If historical OI summaries tab is open, render it.
        const oiSummariesTabContent = document.getElementById('OI_SUMMARIES_tab');
        if (oiSummariesTabContent && oiSummariesTabContent.style.display === 'block') {
            renderHistoricalOiSummaries(data); // Render initial historical summaries
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded fired.");
        const today = moment().format('YYYY-MM-DD');
        document.querySelectorAll('.history-date-picker').forEach(input => input.value = today);

        const pulseContainer = document.getElementById('market-pulse-container');
        if (pulseContainer) { // FIX: Add null check for pulseContainer
            OI_SYMBOLS.forEach(sym => {
                pulseContainer.appendChild(createPulseCard(sym));
            });
        }

        // Initialize OI Summary History Symbol Selector
        const oiSummaryHistorySymbolSelector = $('#oi-summary-history-symbol-selector');
        // Fetch fno_stocks_list_global first, then combine
        fetch('/api/stocks')
            .then(response => response.json())
            .then(stocks => {
                console.log("Fetched stock list:", stocks);
                fno_stocks_list_global = stocks; // Store globally
                const allOiSymbols = [...new Set([...OI_SYMBOLS, ...fno_stocks_list_global])]; // Combine
                if (oiSummaryHistorySymbolSelector.length) { // Check if element exists
                    oiSummaryHistorySymbolSelector.select2({
                        placeholder: "Select Symbol",
                        allowClear: true,
                        data: allOiSymbols.map(sym => ({ id: sym, text: sym }))
                    });
                    // Set default selected symbol if any
                    if (allOiSymbols.length > 0) {
                        oiSummaryHistorySymbolSelector.val(allOiSymbols[0]).trigger('change');
                    }
                }
            })
            .catch(error => {
                console.error("Error fetching stock list for OI summary selector:", error);
                // Fallback if API fails
                const allOiSymbols = [...new Set([...OI_SYMBOLS])];
                if (oiSummaryHistorySymbolSelector.length) { // Check if element exists
                    oiSummaryHistorySymbolSelector.select2({
                        placeholder: "Select Symbol",
                        allowClear: true,
                        data: allOiSymbols.map(sym => ({ id: sym, text: sym }))
                    });
                    if (allOiSymbols.length > 0) {
                        oiSummaryHistorySymbolSelector.val(allOiSymbols[0]).trigger('change');
                    }
                }
            });

        // Add event listener for when the symbol changes
        if (oiSummaryHistorySymbolSelector.length) {
             oiSummaryHistorySymbolSelector.on('change', function() {
                loadOiSummaryHistory(); // Reload history for the new symbol
            });
        }


        // Ensure NIFTY tab is opened first
        const niftyOpenButton = document.getElementById("NIFTYOpen");
        if (niftyOpenButton) {
            niftyOpenButton.click();
            console.log("NIFTYOpen clicked programmatically.");
        } else {
            console.warn("NIFTYOpen button not found.");
        }


        const equitySelector = $('#equity-symbol-selector');
        if (equitySelector.length) { // Check if element exists
            equitySelector.select2({
                placeholder: "Select a stock",
                allowClear: true
            });
        }


        // Re-fetch stocks for the main equity selector if not already done
        if (fno_stocks_list_global.length === 0) {
             fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    console.log("Fetched stock list for main equity selector:", stocks);
                    fno_stocks_list_global = stocks; // Ensure global is updated
                    if (equitySelector.length) {
                        stocks.forEach(stock => {
                            const option = new Option(stock, stock, false, false);
                            equitySelector.append(option);
                        });
                        equitySelector.trigger('change');
                    }
                })
                .catch(error => {
                    console.error("Error fetching stock list:", error);
                });
        } else {
            // If already fetched by the OI summary selector, just populate
            if (equitySelector.length) {
                fno_stocks_list_global.forEach(stock => {
                    const option = new Option(stock, stock, false, false);
                    equitySelector.append(option);
                });
                equitySelector.trigger('change');
            }
        }


        loadInitialBhavcopyData();
        console.log("loadInitialBhavcopyData called from DOMContentLoaded.");

        const fetchEquityBtn = document.getElementById('fetch-equity-btn');
        if (fetchEquityBtn) {
            fetchEquityBtn.addEventListener('click', () => {
                const selectedStock = equitySelector.val();
                if (selectedStock) {
                    const equityDataContainer = document.getElementById('equity-data-container');
                    const equityError = document.getElementById('equity-error');
                    const equityLoader = document.getElementById('equity-loader');

                    if (equityDataContainer) equityDataContainer.classList.add('hidden');
                    if (equityError) equityError.classList.add('hidden');
                    if (equityLoader) equityLoader.classList.remove('hidden');
                    socket.emit('fetch_equity_data', { symbol: selectedStock });
                } else {
                    alert("Please select a stock first.");
                }
            });
        }

        const runBhavcopyBtn = document.getElementById('run-bhavcopy-btn');
        if (runBhavcopyBtn) {
            runBhavcopyBtn.addEventListener('click', () => {
                const equityStatusEl = document.getElementById('bhavcopy-equity-status');
                const indicesStatusEl = document.getElementById('bhavcopy-indices-status');

                if (equityStatusEl) {
                    equityStatusEl.textContent = 'Manual scan triggered... Please wait. Updating F&O equities.';
                    equityStatusEl.style.color = '#FFC107';
                }
                if (indicesStatusEl) {
                    indicesStatusEl.textContent = 'Manual scan triggered... Please wait. Updating indices.';
                    indicesStatusEl.style.color = '#FFC107';
                }

                socket.emit('run_bhavcopy_manually');
            });
        }
    });
</script>
</body>
</html>
