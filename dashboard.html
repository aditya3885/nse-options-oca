<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE OCA PRO WEB</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>NSE OCA PRO LIVE DASHBOARD</h1>

        <div class="ticker-wrap">
            <div class="ticker">
                <div class="ticker-item"><span class="ticker-symbol">NIFTY:</span><span id="ticker-nifty-value" class="ticker-value">-</span><span id="ticker-nifty-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">FINNIFTY:</span><span id="ticker-finnifty-value" class="ticker-value">-</span><span id="ticker-finnifty-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BANKNIFTY:</span><span id="ticker-banknifty-value" class="ticker-value">-</span><span id="ticker-banknifty-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SENSEX:</span><span id="ticker-sensex-value" class="ticker-value">-</span><span id="ticker-sensex-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">INDIAVIX:</span><span id="ticker-indiavix-value" class="ticker-value">-</span><span id="ticker-indiavix-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">GOLD:</span><span id="ticker-gold-value" class="ticker-value">-</span><span id="ticker-gold-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SILVER:</span><span id="ticker-silver-value" class="ticker-value">-</span><span id="ticker-silver-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BTC-USD:</span><span id="ticker-btcusd-value" class="ticker-value">-</span><span id="ticker-btcusd-change" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">USD-INR:</span><span id="ticker-usdinr-value" class="ticker-value">-</span><span id="ticker-usdinr-change" class="ticker-change">-</span></div>
                <!-- Cloned items -->
                <div class="ticker-item"><span class="ticker-symbol">NIFTY:</span><span id="ticker-nifty-value-clone" class="ticker-value">-</span><span id="ticker-nifty-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">FINNIFTY:</span><span id="ticker-finnifty-value-clone" class="ticker-value">-</span><span id="ticker-finnifty-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BANKNIFTY:</span><span id="ticker-banknifty-value-clone" class="ticker-value">-</span><span id="ticker-banknifty-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SENSEX:</span><span id="ticker-sensex-value-clone" class="ticker-value">-</span><span id="ticker-sensex-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">INDIAVIX:</span><span id="ticker-indiavix-value-clone" class="ticker-value">-</span><span id="ticker-indiavix-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">GOLD:</span><span id="ticker-gold-value-clone" class="ticker-value">-</span><span id="ticker-gold-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">SILVER:</span><span id="ticker-silver-value-clone" class="ticker-value">-</span><span id="ticker-silver-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">BTC-USD:</span><span id="ticker-btcusd-value-clone" class="ticker-value">-</span><span id="ticker-btcusd-change-clone" class="ticker-change">-</span></div>
                <div class="ticker-item"><span class="ticker-symbol">USD-INR:</span><span id="ticker-usdinr-value-clone" class="ticker-value">-</span><span id="ticker-usdinr-change-clone" class="ticker-change">-</span></div>
            </div>
        </div>

        <div class="top-movers-container">
            <div class="movers-card">
                <h3 class="gainer-title">Top 10 Strongest (Bullish)</h3>
                <div class="table-container-small">
                    <table id="top-strongest-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="movers-card">
                <h3 class="loser-title">Top 10 Weakest (Bearish)</h3>
                <div class="table-container-small">
                    <table id="top-weakest-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="movers-card">
                <h3 class="gainer-title">Top 10 Getting Better (Potential Buys)</h3>
                <div class="table-container-small">
                    <table id="top-improving-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="movers-card">
                <h3 class="loser-title">Top 10 Getting Worsening (Potential Sells)</h3>
                <div class="table-container-small">
                    <table id="top-worsening-table">
                        <thead><tr><th>#</th><th>Stock</th><th>Score</th><th>Sentiment</th><th>PCR</th></tr></thead>
                        <tbody><tr><td colspan="5">Waiting for data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="market-pulse-container" class="market-pulse-container"></div>

        <div class="grid">
            <div class="card" id="NIFTY_summary"><h2>NIFTY</h2><p>SP: <span id="nifty-sp">-</span></p><p>Value: <span id="nifty-value">-</span></p><p>Call COI: <span id="nifty-call">-K</span></p><p>Put COI: <span id="nifty-put">-K</span></p><p>PCR: <span id="nifty-pcr">-</span></p><p>Sentiment: <span id="nifty-sentiment">-</span></p><p>OI Changes: <span id="nifty-add-exit">-</span></p></div>
            <div class="card" id="FINNIFTY_summary"><h2>FINNIFTY</h2><p>SP: <span id="finnifty-sp">-</span></p><p>Value: <span id="finnifty-value">-</span></p><p>Call COI: <span id="finnifty-call">-K</span></p><p>Put COI: <span id="finnifty-put">-K</span></p><p>PCR: <span id="finnifty-pcr">-</span></p><p>Sentiment: <span id="finnifty-sentiment">-</span></p><p>OI Changes: <span id="finnifty-add-exit">-</span></p></div>
            <div class="card" id="BANKNIFTY_summary"><h2>BANKNIFTY</h2><p>SP: <span id="banknifty-sp">-</span></p><p>Value: <span id="banknifty-value">-</span></p><p>Call COI: <span id="banknifty-call">-K</span></p><p>Put COI: <span id="banknifty-put">-K</span></p><p>PCR: <span id="banknifty-pcr">-</span></p><p>Sentiment: <span id="banknifty-sentiment">-</span></p><p>OI Changes: <span id="banknifty-add-exit">-</span></p></div>
            <div class="card" id="SENSEX_summary"><h2>SENSEX</h2><p>Value: <span id="sensex-value">-</span></p><p>Change: <span id="sensex-change">-</span></p><p>Pct Change: <span id="sensex-pct">-%</span></p><p>Sentiment: <span id="sensex-sentiment">-</span></p></div>
            <div class="card" id="INDIAVIX_summary"><h2>INDIAVIX</h2><p>Value: <span id="indiavix-value">-</span></p><p>Change: <span id="indiavix-change">-</span></p><p>Pct Change: <span id="indiavix-pct">-%</span></p><p>Sentiment: <span id="indiavix-sentiment">-</span></p></div>
        </div>

        <div class="tabs">
            <button class="tablink active" onclick="openTab(event, 'NIFTY')" id="NIFTYOpen" data-symbol="NIFTY">NIFTY</button>
            <button class="tablink" onclick="openTab(event, 'FINNIFTY')" data-symbol="FINNIFTY">FINNIFTY</button>
            <button class="tablink" onclick="openTab(event, 'BANKNIFTY')" data-symbol="BANKNIFTY">BANKNIFTY</button>
            <button class="tablink" onclick="openTab(event, 'EQUITY')" data-symbol="EQUITY">Equity</button>
            <button class="tablink" onclick="openTab(event, 'SENSEX')" data-symbol="SENSEX">SENSEX</button>
            <button class="tablink" onclick="openTab(event, 'INDIAVIX')" data-symbol="INDIAVIX">INDIAVIX</button>
            <button class="tablink" onclick="openTab(event, 'BHAVCOPY')" data-symbol="BHAVCOPY">Bhavcopy</button>
            <button class="tablink" onclick="openTab(event, 'BHAVCOPY_STRATEGIES')" data-symbol="BHAVCOPY_STRATEGIES">Bhavcopy Strategies</button>
        </div>

        <div class="global-controls"><button class="clear-history-button" onclick="clearTodaysHistory(null)">Clear All Today's History</button></div>

        <div id="NIFTY_tab" class="tabcontent" style="display: block;">
            <h3 style="margin-top: 20px;">NIFTY Today's Updates (Newest First)</h3><div class="table-container"><table id="nifty-todays-history-table"><thead><tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr></thead><tbody></tbody></table></div>
            <h3>NIFTY Charts</h3><div class="chart-grid"><div class="chart-container"><canvas id="nifty-pcr-chart"></canvas></div><div class="chart-container"><canvas id="nifty-max-pain-chart"></canvas></div><div class="chart-container"><canvas id="nifty-ce-oi-chart"></canvas></div><div class="chart-container"><canvas id="nifty-pe-oi-chart"></canvas></div></div>
            <h3>NIFTY Option Chain (ATM ±10)</h3><div class="table-container"><table id="nifty-table"><thead><tr><th>Call Buildup</th><th>Strike</th><th>Call OI</th><th>Call COI</th><th class="action-header">Call Action</th><th>Put OI</th><th>Put COI</th><th class="action-header">Put Action</th><th>Put Buildup</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">NIFTY Historical Data</h3><div class="history-controls"><label for="nifty-history-date">Date:</label><input type="date" id="nifty-history-date" class="history-date-picker"><button onclick="loadHistoricalData('NIFTY')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('NIFTY')">Clear Today's NIFTY History</button></div>
            <div class="table-container"><table id="nifty-historical-data-table"><thead><tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="FINNIFTY_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">FINNIFTY Today's Updates (Newest First)</h3><div class="table-container"><table id="finnifty-todays-history-table"><thead><tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr></thead><tbody></tbody></table></div>
            <h3>FINNIFTY Charts</h3><div class="chart-grid"><div class="chart-container"><canvas id="finnifty-pcr-chart"></canvas></div><div class="chart-container"><canvas id="finnifty-max-pain-chart"></canvas></div><div class="chart-container"><canvas id="finnifty-ce-oi-chart"></canvas></div><div class="chart-container"><canvas id="finnifty-pe-oi-chart"></canvas></div></div>
            <h3>FINNIFTY Option Chain (ATM ±10)</h3><div class="table-container"><table id="finnifty-table"><thead><tr><th>Call Buildup</th><th>Strike</th><th>Call OI</th><th>Call COI</th><th class="action-header">Call Action</th><th>Put OI</th><th>Put COI</th><th class="action-header">Put Action</th><th>Put Buildup</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">FINNIFTY Historical Data</h3><div class="history-controls"><label for="finnifty-history-date">Date:</label><input type="date" id="finnifty-history-date" class="history-date-picker"><button onclick="loadHistoricalData('FINNIFTY')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('FINNIFTY')">Clear Today's FINNIFTY History</button></div>
            <div class="table-container"><table id="finnifty-historical-data-table"><thead><tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="BANKNIFTY_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">BANKNIFTY Today's Updates (Newest First)</h3><div class="table-container"><table id="banknifty-todays-history-table"><thead><tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr></thead><tbody></tbody></table></div>
            <h3>BANKNIFTY Charts</h3><div class="chart-grid"><div class="chart-container"><canvas id="banknifty-pcr-chart"></canvas></div><div class="chart-container"><canvas id="banknifty-max-pain-chart"></canvas></div><div class="chart-container"><canvas id="banknifty-ce-oi-chart"></canvas></div><div class="chart-container"><canvas id="banknifty-pe-oi-chart"></canvas></div></div>
            <h3>BANKNIFTY Option Chain (ATM ±10)</h3><div class="table-container"><table id="banknifty-table"><thead><tr><th>Call Buildup</th><th>Strike</th><th>Call OI</th><th>Call COI</th><th class="action-header">Call Action</th><th>Put OI</th><th>Put COI</th><th class="action-header">Put Action</th><th>Put Buildup</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">BANKNIFTY Historical Data</h3><div class="history-controls"><label for="banknifty-history-date">Date:</label><input type="date" id="banknifty-history-date" class="history-date-picker"><button onclick="loadHistoricalData('BANKNIFTY')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('BANKNIFTY')">Clear Today's BANKNIFTY History</button></div>
            <div class="table-container"><table id="banknifty-historical-data-table"><thead><tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="SENSEX_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">SENSEX Today's Updates (Newest First)</h3><div class="table-container"><table id="sensex-todays-history-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">SENSEX Historical Data</h3><div class="history-controls"><label for="sensex-history-date">Date:</label><input type="date" id="sensex-history-date" class="history-date-picker"><button onclick="loadHistoricalData('SENSEX')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('SENSEX')">Clear Today's SENSEX History</button></div>
            <div class="table-container"><table id="sensex-historical-data-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div id="INDIAVIX_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">INDIAVIX Today's Updates (Newest First)</h3><div class="table-container"><table id="indiavix-todays-history-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment</th></tr></thead><tbody></tbody></table></div>
            <h3 style="margin-top: 20px;">INDIAVIX Historical Data</h3><div class="history-controls"><label for="indiavix-history-date">Date:</label><input type="date" id="indiavix-history-date" class="history-date-picker"><button onclick="loadHistoricalData('INDIAVIX')">Load History</button><button class="clear-history-button-small" onclick="clearTodaysHistory('INDIAVIX')">Clear Today's INDIAVIX History</button></div>
            <div class="table-container"><table id="indiavix-historical-data-table"><thead><tr><th>Time</th><th>Value</th><th>Change</th><th>Pct Change</th><th>Sentiment</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="EQUITY_tab" class="tabcontent">
            <div class="equity-selector-bar">
                <label for="equity-symbol-selector">Select Stock:</label>
                <select id="equity-symbol-selector" style="width: 250px;"></select>
                <button id="fetch-equity-btn">Fetch Data</button>
            </div>
            <div id="equity-data-container" class="hidden">
                <h2 id="equity-title" style="text-align: center; margin-bottom: 20px;"></h2>
                <div id="equity-market-pulse-container" class="market-pulse-container"></div>
                <div class="grid">
                    <div class="card" id="EQUITY_summary_card">
                        <h2>Summary</h2>
                        <p>SP: <span id="equity-sp">-</span></p>
                        <p>Value: <span id="equity-value">-</span></p>
                        <p>PCR: <span id="equity-pcr">-</span></p>
                        <p>Intraday PCR: <span id="equity-intraday-pcr">-</span></p>
                        <p>Sentiment: <span id="equity-sentiment">-</span></p>
                    </div>
                </div>
                <h3>Option Chain (ATM ±10)</h3>
                <div class="table-container">
                    <table id="equity-table">
                        <thead>
                            <tr>
                                <th>Call Buildup</th>
                                <th>Strike</th>
                                <th>Call OI</th>
                                <th>Call COI</th>
                                <th class="action-header">Call Action</th>
                                <th>Put OI</th>
                                <th>Put COI</th>
                                <th class="action-header">Put Action</th>
                                <th>Put Buildup</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3 style="margin-top: 20px;">Equity Historical Data</h3>
                <div class="history-controls">
                    <label for="equity-history-date">Date:</label>
                    <input type="date" id="equity-history-date" class="history-date-picker">
                    <button onclick="loadHistoricalData('EQUITY')">Load History</button>
                </div>
                <div class="table-container">
                    <table id="equity-historical-data-table">
                        <thead>
                            <tr><th>Time</th><th>SP</th><th>Value</th><th>Call COI</th><th>Put COI</th><th>PCR</th><th>ΔPCR</th><th>Intraday PCR</th><th>Sentiment</th><th style="width: 30%;">OI Changes</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="equity-loader" class="hidden" style="text-align: center; padding: 40px;">Loading...</div>
            <div id="equity-error" class="hidden" style="text-align: center; padding: 40px; color: #F44336;"></div>
        </div>

        <!-- +++ MODIFIED: Added history controls to Bhavcopy tab +++ -->
        <div id="BHAVCOPY_tab" class="tabcontent">
            <h3 id="bhavcopy-title">Bhavcopy Daily Scanner</h3>
            <div class="bhavcopy-controls">
                <button id="run-bhavcopy-btn">Run Scanner Manually</button>
                <div class="history-controls" style="justify-content: center; margin-top: 15px;">
                    <label for="bhavcopy-history-date">View History:</label>
                    <input type="date" id="bhavcopy-history-date" class="history-date-picker">
                    <button onclick="loadBhavcopyHistory()">Load History</button>
                </div>
            </div>
            <p id="bhavcopy-status" style="text-align: center; margin-bottom: 20px;">Fetching latest Bhavcopy data...</p>
            <div class="table-container">
                <table id="bhavcopy-equity-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Close</th>
                            <th>Volume</th>
                            <th>% Change</th>
                            <th>Delivery %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- +++ NEW: Bhavcopy Strategies Tab +++ -->
        <div id="BHAVCOPY_STRATEGIES_tab" class="tabcontent">
            <h3 style="margin-top: 20px;">Bhavcopy Derived Trading Strategies</h3>
            <p>Select a date to analyze Bhavcopy data for potential trading signals. The strategies below are generated based on the selected day's data.</p>
            <div class="history-controls" style="justify-content: center; margin-top: 15px; margin-bottom: 20px;">
                <label for="strategy-bhavcopy-date">Select Date:</label>
                <input type="date" id="strategy-bhavcopy-date" class="history-date-picker">
                <button onclick="analyzeBhavcopyStrategies()">Analyze Strategies</button>
            </div>

            <div id="strategy-results-container">
                <p id="strategy-status" style="text-align: center; margin-bottom: 20px;">Select a date and click "Analyze Strategies" to see results.</p>

                <h4>1. Price Action: Breakouts & Breakdowns</h4>
                <div class="table-container">
                    <table id="strategy-breakouts-table">
                        <thead><tr><th>Symbol</th><th>Close</th><th>% Change</th><th>Volume</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="5">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>2. Volume Analysis: High Volume Movers</h4>
                <div class="table-container">
                    <table id="strategy-volume-table">
                        <thead><tr><th>Symbol</th><th>Close</th><th>% Change</th><th>Volume</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="5">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>3. Delivery-Based Buying/Selling (Last 5-8 Days Trend)</h4>
                <p>This section analyzes the trend of delivery percentage over the last few days to identify potential accumulation or distribution.</p>
                <div class="table-container">
                    <table id="strategy-delivery-table">
                        <thead><tr><th>Symbol</th><th>Latest Close</th><th>Latest Delivery %</th><th>Average Delivery % (5-day)</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="5">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>4. Gaps Analysis</h4>
                <p>Stocks that opened with significant gaps (up or down) from the previous day's close.</p>
                <div class="table-container">
                    <table id="strategy-gaps-table">
                        <thead><tr><th>Symbol</th><th>Open</th><th>Close</th><th>Prev. Close</th><th>Gap %</th><th>Signal</th></tr></thead>
                        <tbody><tr><td colspan="6">No data available.</td></tr></tbody>
                    </table>
                </div>

                <h4>5. Support & Resistance (Daily Pivots)</h4>
                <p>Calculated daily pivot points, support, and resistance levels based on the selected day's OHLCC data.</p>
                <div class="table-container">
                    <table id="strategy-pivot-table">
                        <thead><tr><th>Symbol</th><th>Pivot</th><th>R1</th><th>R2</th><th>R3</th><th>S1</th><th>S2</th><th>S3</th></tr></thead>
                        <tbody><tr><td colspan="8">No data available.</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>


        <footer>@aditya_nse_bot | Updated: <span id="time">-</span> | Site Visits: <span id="visit-counter">-</span></footer>
    </div>

    <div class="disclaimer-ticker-wrap">
        <div class="disclaimer-ticker">
            <span class="disclaimer-text">Disclaimer: 9 out of 10 individual traders in the Equity Futures and Options Segment incurred net losses. On average, loss-makers registered net trading losses close to ₹50,000. Over and above the net trading losses incurred, loss-makers expended an additional 28% of net trading losses as transaction costs. This tool is for educational purposes only and does not constitute investment advice. Please consult a SEBI-registered financial advisor before trading.
            </span>
            <span class="disclaimer-text">Disclaimer: 9 out of 10 individual traders in the Equity Futures and Options Segment incurred net losses. On average, loss-makers registered net trading losses close to ₹50,000. Over and above the net trading losses incurred, loss-makers expended an additional 28% of net trading losses as transaction costs. This tool is for educational purposes only and does not constitute investment advice. Please consult a SEBI-registered financial advisor before trading.
            </span>
        </div>
    </div>

    <script>
        const socket = io();
        const charts = {};
        const shared_data_cache = {};
        const ALL_SYMBOLS = ["NIFTY", "FINNIFTY", "BANKNIFTY", "SENSEX", "INDIAVIX", "GOLD", "SILVER", "BTC-USD", "USD-INR"];
        const OI_SYMBOLS = ["NIFTY", "FINNIFTY", "BANKNIFTY"];
        const SIMPLE_ASSETS = ["SENSEX", "INDIAVIX"];

        function openTab(evt, symbol) {
            document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
            document.querySelectorAll(".tablink").forEach(el => el.classList.remove("active"));
            document.getElementById(`${symbol}_tab`).style.display = "block";
            evt.currentTarget.classList.add("active");
            if (!SIMPLE_ASSETS.includes(symbol) && shared_data_cache[symbol] && symbol !== "EQUITY" && symbol !== "BHAVCOPY" && symbol !== "BHAVCOPY_STRATEGIES") {
                updateCharts(symbol, shared_data_cache[symbol]);
            }
        }

        function renderChart(chartId, chartType, labels, data, label, backgroundColor, borderColor) {
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            if (charts[chartId]) charts[chartId].destroy();
            charts[chartId] = new Chart(ctx, {
                type: chartType,
                data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: backgroundColor, borderColor: borderColor, borderWidth: 1, fill: chartType === 'line' ? false : true, tension: chartType === 'line' ? 0.4 : 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { color: '#bbb' } } }, scales: { x: { ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { beginAtZero: false, ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.1)' } } } }
            });
        }

        function addHistoryItemToTable(tbody, item, symbol, prepend = false) {
            const tr = document.createElement('tr');
            if (SIMPLE_ASSETS.includes(symbol)) {
                tr.innerHTML = `<td>${item.time}</td><td>${item.value.toLocaleString('en-IN')}</td><td style="color: ${item.sp >= 0 ? '#4CAF50' : '#F44336'}">${item.sp >= 0 ? '+' : ''}${item.sp.toFixed(2)}</td><td style="color: ${item.pcr >= 0 ? '#4CAF50' : '#F44336'}">${item.pcr >= 0 ? '+' : ''}${item.pcr.toFixed(2)}%</td><td style="color: ${item.sentiment.includes('Bullish') ? '#4CAF50' : '#FFC107'}">${item.sentiment}</td>`;
            } else {
                const pcrChange = item.pcr_change || 0.0;
                const intradayPcr = item.intraday_pcr || 0.0;
                const pcrChangeColor = pcrChange > 0 ? '#4CAF50' : (pcrChange < 0 ? '#F44336' : '#fff');
                const intradayPcrColor = intradayPcr > 1.2 ? '#4CAF50' : (intradayPcr < 0.8 && intradayPcr != 0) ? '#F44336' : '#fff';
                tr.innerHTML = `<td>${item.time}</td><td>${item.sp}</td><td>${item.value}</td><td>${item.call_oi || '-'}K</td><td>${item.put_oi || '-'}K</td><td>${item.pcr.toFixed(2)}</td><td style="color: ${pcrChangeColor};">${pcrChange >= 0 ? '+' : ''}${pcrChange.toFixed(2)}</td><td style="color: ${intradayPcrColor};">${intradayPcr.toFixed(2)}</td><td style="color: ${item.sentiment.includes('Bullish') ? '#4CAF50' : '#FFC107'}">${item.sentiment}</td><td>${item.add_exit || '-'}</td>`;
            }
            if (prepend) tbody.prepend(tr); else tbody.appendChild(tr);
        }

        async function loadHistoricalData(symbol) {
            let effectiveSymbol = symbol;
            if (symbol === 'EQUITY') {
                effectiveSymbol = $('#equity-symbol-selector').val();
                if (!effectiveSymbol) {
                    alert("Please select a stock first.");
                    return;
                }
            }
            const lower = symbol.toLowerCase();
            const dateInput = document.getElementById(`${lower}-history-date`);
            const historicalTbody = document.querySelector(`#${lower}-historical-data-table tbody`);
            if (!dateInput || !historicalTbody) return;

            const selectedDate = dateInput.value;
            if (!selectedDate) { alert("Please select a date."); return; }

            const colspan = SIMPLE_ASSETS.includes(symbol) ? 5 : 10;
            historicalTbody.innerHTML = `<tr><td colspan="${colspan}">Loading...</td></tr>`;
            try {
                const response = await fetch(`/history/${effectiveSymbol}/${selectedDate}`);
                const data = await response.json();
                historicalTbody.innerHTML = '';
                if (data.error || data.history.length === 0) {
                    historicalTbody.innerHTML = `<tr><td colspan="${colspan}" style="color: red;">${data.error || 'No data found for this date.'}</td></tr>`;
                    return;
                }
                data.history.forEach(item => addHistoryItemToTable(historicalTbody, item, effectiveSymbol, false));
            } catch (error) {
                historicalTbody.innerHTML = `<tr><td colspan="${colspan}" style="color: red;">Failed to load history. Check console for errors.</td></tr>`;
                console.error("Error loading historical data:", error);
            }
        }

        function getBuildupClass(buildup) {
            if (!buildup) return '';
            if (buildup.includes('Long Buildup')) return 'buildup-long';
            if (buildup.includes('Short Buildup')) return 'buildup-short';
            if (buildup.includes('Short Covering')) return 'buildup-short-covering';
            if (buildup.includes('Long Unwinding')) return 'buildup-long-unwinding';
            if (buildup.includes('Fresh OI Added')) return 'buildup-long';
            if (buildup.includes('OI Exited')) return 'buildup-short';
            return '';
        }

        function createPulseCard(symbol) {
            const lower = symbol.toLowerCase();
            const card = document.createElement('div');
            card.className = 'pulse-card';
            card.innerHTML = `
                <h3>${symbol === 'EQUITY' ? 'Equity' : symbol} Pulse</h3>
                <div class="pulse-row"><span>CALLS</span><div class="pulse-bar-container"><div class="pulse-bar calls" id="${lower}-total-call-oi-bar"></div><div class="pulse-bar puts" id="${lower}-total-put-oi-bar"></div></div><span>PUTS</span></div>
                <div class="pulse-labels"><span>-</span><span id="${lower}-total-put-oi-label">-</span></div>
                <h5>Today's Change</h5>
                <div class="pulse-row"><span>CALLS Δ</span><div class="pulse-bar-container"><div class="pulse-bar calls-change" id="${lower}-total-call-coi-bar"></div><div class="pulse-bar puts-change" id="${lower}-total-put-coi-bar"></div></div><span>PUTS Δ</span></div>
                <div class="pulse-labels"><span>-</span><span id="${lower}-total-put-coi-label">-</span></div>
            `;
            // Update the span IDs for call labels
            card.querySelector('.pulse-labels span:first-child').id = `${lower}-total-call-oi-label`;
            card.querySelectorAll('.pulse-labels')[1].querySelector('span:first-child').id = `${lower}-total-call-coi-label`;
            return card;
        }

        function updateBhavcopyTables(data) {
            const statusEl = document.getElementById('bhavcopy-status');
            const titleEl = document.getElementById('bhavcopy-title');
            const equityTbody = document.querySelector('#bhavcopy-equity-table tbody');

            if (!data || !data.date) {
                statusEl.textContent = 'No Bhavcopy data available yet. The scanner runs automatically after 9 PM IST or can be run manually.';
                statusEl.style.color = '#fff';
                return;
            }

            titleEl.textContent = `Bhavcopy Daily Scanner - Data for ${data.date}`;
            statusEl.textContent = 'Latest data loaded successfully.';
            statusEl.style.color = '#4CAF50';
            equityTbody.innerHTML = '';

            if (data.equities && data.equities.length > 0) {
                data.equities.forEach(stock => {
                    const tr = document.createElement('tr');
                    const changeColor = stock['% Change'] >= 0 ? '#4CAF50' : '#F44336';
                    tr.innerHTML = `
                        <td>${stock.Symbol}</td>
                        <td>${stock.Close.toLocaleString('en-IN')}</td>
                        <td>${stock.Volume.toLocaleString('en-IN')}</td>
                        <td style="color: ${changeColor}">${stock['% Change'].toFixed(2)}%</td>
                        <td>${stock['Delivery %']}</td>
                    `;
                    equityTbody.appendChild(tr);
                });
            } else {
                equityTbody.innerHTML = '<tr><td colspan="5">No equity data found for this date.</td></tr>';
            }
        }

        // +++ NEW: Function to load historical Bhavcopy data from the new API +++
        async function loadBhavcopyHistory() {
            const dateInput = document.getElementById('bhavcopy-history-date');
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                alert("Please select a date.");
                return;
            }
            const statusEl = document.getElementById('bhavcopy-status');
            const equityTbody = document.querySelector('#bhavcopy-equity-table tbody');
            statusEl.textContent = `Loading Bhavcopy for ${selectedDate}...`;
            statusEl.style.color = '#FFC107'; // Yellow for loading
            equityTbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

            try {
                const response = await fetch(`/api/bhavcopy/${selectedDate}`);
                const data = await response.json();
                if (data.error || !data.equities || data.equities.length === 0) {
                    statusEl.textContent = data.error || `No Bhavcopy data found for ${selectedDate}.`;
                    statusEl.style.color = '#F44336'; // Red for error/not found
                    equityTbody.innerHTML = `<tr><td colspan="5">${data.error || `No Bhavcopy data found for ${selectedDate}.`}</td></tr>`;
                } else {
                    updateBhavcopyTables(data); // Reuse the existing update function
                }
            } catch (error) {
                statusEl.textContent = 'Failed to load historical data.';
                statusEl.style.color = '#F44336';
                equityTbody.innerHTML = '<tr><td colspan="5">Failed to load data.</td></tr>';
                console.error("Error loading historical bhavcopy:", error);
            }
        }

        async function clearTodaysHistory(symbol) {
            const confirmation = confirm(`Are you sure you want to clear ALL of today's history data for ${symbol || 'all symbols'}? This cannot be undone.`);
            if (confirmation) {
                try {
                    const response = await fetch('/clear_todays_history', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: symbol })
                    });
                    const result = await response.json();
                    alert(result.message);
                    window.location.reload();
                } catch (error) {
                    alert('An error occurred while clearing history.');
                    console.error(error);
                }
            }
        }

        // +++ NEW: Function to analyze Bhavcopy strategies +++
        async function analyzeBhavcopyStrategies() {
            const dateInput = document.getElementById('strategy-bhavcopy-date');
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                alert("Please select a date for Bhavcopy analysis.");
                return;
            }

            const strategyStatusEl = document.getElementById('strategy-status');
            strategyStatusEl.textContent = `Analyzing Bhavcopy strategies for ${selectedDate}...`;
            strategyStatusEl.style.color = '#FFC107';

            // Clear previous results
            document.querySelectorAll('#strategy-results-container table tbody').forEach(tbody => {
                tbody.innerHTML = '<tr><td colspan="'+ tbody.previousElementSibling.querySelector('thead tr').children.length +'">Analyzing...</td></tr>';
            });

            try {
                const response = await fetch(`/api/bhavcopy/${selectedDate}`);
                const data = await response.json();

                if (data.error || !data.equities || data.equities.length === 0) {
                    strategyStatusEl.textContent = data.error || `No Bhavcopy data found for ${selectedDate} to analyze strategies.`;
                    strategyStatusEl.style.color = '#F44336';
                    document.querySelectorAll('#strategy-results-container table tbody').forEach(tbody => {
                        tbody.innerHTML = '<tr><td colspan="'+ tbody.previousElementSibling.querySelector('thead tr').children.length +'">No data available.</td></tr>';
                    });
                    return;
                }

                const equities = data.equities;
                strategyStatusEl.textContent = `Strategies analyzed for ${selectedDate}.`;
                strategyStatusEl.style.color = '#4CAF50';

                // Implement Strategy Logic Here
                updateBreakoutsTable(equities);
                updateVolumeTable(equities);
                await updateDeliveryTable(equities, selectedDate); // Requires historical delivery data
                updateGapsTable(equities);
                updatePivotTable(equities);

            } catch (error) {
                strategyStatusEl.textContent = 'Failed to analyze Bhavcopy strategies. An error occurred.';
                strategyStatusEl.style.color = '#F44336';
                console.error("Error analyzing Bhavcopy strategies:", error);
                document.querySelectorAll('#strategy-results-container table tbody').forEach(tbody => {
                    tbody.innerHTML = '<tr><td colspan="'+ tbody.previousElementSibling.querySelector('thead tr').children.length +'">Error during analysis.</td></tr>';
                });
            }
        }

        // Helper function for Breakouts & Volume
        function updateBreakoutsTable(equities) {
            const tbody = document.querySelector('#strategy-breakouts-table tbody');
            tbody.innerHTML = '';
            const breakouts = equities.filter(s => s['% Change'] > 3 && s.Volume > 1000000); // Example criteria
            if (breakouts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No significant breakouts/breakdowns found.</td></tr>';
                return;
            }
            breakouts.forEach(stock => {
                const signal = stock['% Change'] > 0 ? 'Bullish Breakout' : 'Bearish Breakdown';
                const color = stock['% Change'] > 0 ? '#4CAF50' : '#F44336';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${stock.Symbol}</td><td>${stock.Close.toFixed(2)}</td><td style="color:${color}">${stock['% Change'].toFixed(2)}%</td><td>${stock.Volume.toLocaleString()}</td><td>${signal}</td>`;
                tbody.appendChild(tr);
            });
        }

        function updateVolumeTable(equities) {
            const tbody = document.querySelector('#strategy-volume-table tbody');
            tbody.innerHTML = '';
            const highVolume = equities.filter(s => s.Volume > 2000000).sort((a,b) => b.Volume - a.Volume); // Example criteria
            if (highVolume.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No high volume movers found.</td></tr>';
                return;
            }
            highVolume.forEach(stock => {
                const signal = 'High Volume Activity';
                const color = stock['% Change'] >= 0 ? '#4CAF50' : '#F44336';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${stock.Symbol}</td><td>${stock.Close.toFixed(2)}</td><td style="color:${color}">${stock['% Change'].toFixed(2)}%</td><td>${stock.Volume.toLocaleString()}</td><td>${signal}</td>`;
                tbody.appendChild(tr);
            });
        }

        async function updateDeliveryTable(currentEquities, selectedDate) {
            const tbody = document.querySelector('#strategy-delivery-table tbody');
            tbody.innerHTML = '';

            const allDeliveryData = {}; // Store delivery data for each stock over multiple days

            for (let i = 0; i < 8; i++) { // Fetch delivery data for last 8 days
                const date = new Date(selectedDate);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                try {
                    const response = await fetch(`/api/bhavcopy/${dateStr}`);
                    const data = await response.json();

                    if (!data.error && data.equities && data.equities.length > 0) {
                        data.equities.forEach(stock => {
                            if (!allDeliveryData[stock.Symbol]) {
                                allDeliveryData[stock.Symbol] = [];
                            }
                            // Ensure Delivery % is a number for calculations, default to 0 if 'N/A'
                            const deliveryPct = parseFloat(stock['Delivery %']);
                            if (!isNaN(deliveryPct)) {
                                allDeliveryData[stock.Symbol].push(deliveryPct);
                            }
                        });
                    }
                } catch (error) {
                    console.warn(`Could not fetch historical bhavcopy for ${dateStr}:`, error);
                }
            }

            const deliverySignals = [];
            currentEquities.forEach(stock => {
                const symbol = stock.Symbol;
                const latestClose = stock.Close;
                const latestDeliveryPct = parseFloat(stock['Delivery %']);

                if (allDeliveryData[symbol] && allDeliveryData[symbol].length > 1) {
                    const deliveryPcts = allDeliveryData[symbol];
                    const avgDeliveryPct = deliveryPcts.reduce((sum, val) => sum + val, 0) / deliveryPcts.length;

                    let signal = 'Neutral';
                    let signalColor = '#fff';

                    if (!isNaN(latestDeliveryPct) && latestDeliveryPct > avgDeliveryPct * 1.2 && stock['% Change'] > 0) {
                        signal = 'Strong Delivery Buying (Accumulation)';
                        signalColor = '#4CAF50';
                    } else if (!isNaN(latestDeliveryPct) && latestDeliveryPct < avgDeliveryPct * 0.8 && stock['% Change'] < 0) {
                        signal = 'Strong Delivery Selling (Distribution)';
                        signalColor = '#F44336';
                    } else if (!isNaN(latestDeliveryPct) && latestDeliveryPct > avgDeliveryPct * 1.1) {
                        signal = 'Increased Delivery Buying';
                        signalColor = '#81c784';
                    } else if (!isNaN(latestDeliveryPct) && latestDeliveryPct < avgDeliveryPct * 0.9) {
                        signal = 'Decreased Delivery Buying';
                        signalColor = '#e57373';
                    }

                    deliverySignals.push({
                        Symbol: symbol,
                        LatestClose: latestClose,
                        LatestDeliveryPct: isNaN(latestDeliveryPct) ? 'N/A' : latestDeliveryPct.toFixed(2) + '%',
                        AvgDeliveryPct: avgDeliveryPct.toFixed(2) + '%',
                        Signal: signal,
                        SignalColor: signalColor
                    });
                }
            });

            if (deliverySignals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No significant delivery trends found or insufficient historical data.</td></tr>';
                return;
            }

            deliverySignals.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.Symbol}</td><td>${item.LatestClose.toFixed(2)}</td><td>${item.LatestDeliveryPct}</td><td>${item.AvgDeliveryPct}</td><td style="color:${item.SignalColor}">${item.Signal}</td>`;
                tbody.appendChild(tr);
            });
        }


        function updateGapsTable(equities) {
            const tbody = document.querySelector('#strategy-gaps-table tbody');
            tbody.innerHTML = '';
            const gaps = [];
            equities.forEach(stock => {
                // To calculate gaps accurately, we need previous day's close.
                // For simplicity here, we'll assume we can get it or use a placeholder.
                // In a real scenario, you'd fetch yesterday's bhavcopy.
                const open = stock.Open || stock.Close; // Placeholder if Open is not directly available in this simplified structure
                const prevClose = stock.Close / (1 + (stock['% Change'] / 100)); // Estimate prev close
                const gapPct = ((open - prevClose) / prevClose * 100);

                if (Math.abs(gapPct) > 1) { // Significant gap, e.g., > 1%
                    const signal = gapPct > 0 ? 'Gap Up' : 'Gap Down';
                    const color = gapPct > 0 ? '#4CAF50' : '#F44336';
                    gaps.push({
                        Symbol: stock.Symbol,
                        Open: open.toFixed(2),
                        Close: stock.Close.toFixed(2),
                        PrevClose: prevClose.toFixed(2),
                        GapPct: gapPct.toFixed(2),
                        Signal: signal,
                        SignalColor: color
                    });
                }
            });

            if (gaps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No significant gaps found.</td></tr>';
                return;
            }

            gaps.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.Symbol}</td><td>${item.Open}</td><td>${item.Close}</td><td>${item.PrevClose}</td><td style="color:${item.SignalColor}">${item.GapPct}%</td><td>${item.Signal}</td>`;
                tbody.appendChild(tr);
            });
        }

        function updatePivotTable(equities) {
            const tbody = document.querySelector('#strategy-pivot-table tbody');
            tbody.innerHTML = '';

            const pivots = [];
            equities.forEach(stock => {
                // Assuming we have OHLC for the day in Bhavcopy data.
                // In this simplified structure, we only have Close. For accurate pivots,
                // you'd need Open, High, Low, Close from the bhavcopy.
                // For demonstration, let's use Close as a proxy for O,H,L for pivot calculation, which is not ideal for actual trading.
                // A better approach would be to parse the full bhavcopy CSV which includes OHLC.
                const H = stock.High || stock.Close * 1.05; // Placeholder
                const L = stock.Low || stock.Close * 0.95;  // Placeholder
                const C = stock.Close;

                const P = (H + L + C) / 3;
                const R1 = (2 * P) - L;
                const S1 = (2 * P) - H;
                const R2 = P + (H - L);
                const S2 = P - (H - L);
                const R3 = H + (2 * (P - L));
                const S3 = L - (2 * (H - P));

                pivots.push({
                    Symbol: stock.Symbol,
                    Pivot: P.toFixed(2),
                    R1: R1.toFixed(2),
                    R2: R2.toFixed(2),
                    R3: R3.toFixed(2),
                    S1: S1.toFixed(2),
                    S2: S2.toFixed(2),
                    S3: S3.toFixed(2),
                });
            });

            if (pivots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No pivot data available. (Requires Open, High, Low, Close data)</td></tr>';
                return;
            }

            pivots.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.Symbol}</td><td>${item.Pivot}</td><td>${item.R1}</td><td>${item.R2}</td><td>${item.R3}</td><td>${item.S1}</td><td>${item.S2}</td><td>${item.S3}</td>`;
                tbody.appendChild(tr);
            });
        }


        socket.on('initial_todays_history', (data) => {
            if (!data.history) return;
            Object.keys(data.history).forEach(sym => {
                const historyTbody = document.querySelector(`#${sym.toLowerCase()}-todays-history-table tbody`);
                if (historyTbody) {
                    historyTbody.innerHTML = '';
                    data.history[sym].forEach(item => addHistoryItemToTable(historyTbody, item, sym, false));
                }
            });
        });

        socket.on('todays_history_append', (data) => {
            if (data.symbol && data.item) {
                const historyTbody = document.querySelector(`#${data.symbol.toLowerCase()}-todays-history-table tbody`);
                if (historyTbody) addHistoryItemToTable(historyTbody, data.item, data.symbol, true);
            }
        });

        socket.on('update_visits', (data) => {
            document.getElementById('visit-counter').textContent = data.count;
        });

        socket.on('top_movers_update', (data) => {
            const strongestTbody = document.querySelector('#top-strongest-table tbody');
            const weakestTbody = document.querySelector('#top-weakest-table tbody');
            const improvingTbody = document.querySelector('#top-improving-table tbody');
            const worseningTbody = document.querySelector('#top-worsening-table tbody');

            [strongestTbody, weakestTbody, improvingTbody, worseningTbody].forEach(tbody => tbody.innerHTML = '');

            data.strongest.forEach((stock, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${stock.score}</td><td>${stock.sentiment}</td><td>${stock.pcr}</td>`;
                strongestTbody.appendChild(tr);
            });
            data.weakest.forEach((stock, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${stock.score}</td><td>${stock.sentiment}</td><td>${stock.pcr}</td>`;
                weakestTbody.appendChild(tr);
            });
            data.improving.forEach((stock, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${stock.score}</td><td>${stock.sentiment}</td><td>${stock.pcr}</td>`;
                improvingTbody.appendChild(tr);
            });
            data.worsening.forEach((stock, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${index + 1}</td><td>${stock.symbol}</td><td>${stock.score}</td><td>${stock.sentiment}</td><td>${stock.pcr}</td>`;
                worseningTbody.appendChild(tr);
            });
        });

        socket.on('bhavcopy_update', (data) => {
            console.log("Received live Bhavcopy update:", data);
            updateBhavcopyTables(data);
        });

        socket.on('update', (data) => {
            document.getElementById('time').textContent = new Date().toLocaleTimeString();

            if (data.live_feed_summary) {
                ALL_SYMBOLS.forEach(sym => {
                    const lower = sym.toLowerCase().replace(/-/g, '');
                    const feed = data.live_feed_summary[sym];
                    const valEl = document.getElementById(`ticker-${lower}-value`);
                    const chgEl = document.getElementById(`ticker-${lower}-change`);
                    const valElClone = document.getElementById(`ticker-${lower}-value-clone`);
                    const chgElClone = document.getElementById(`ticker-${lower}-change-clone`);

                    if (feed && typeof feed.current_value !== 'undefined' && valEl && chgEl) {
                        const valText = feed.current_value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 4});
                        const chgText = `${feed.change >= 0 ? '▲' : '▼'} ${Math.abs(feed.change).toFixed(2)} (${feed.percentage_change.toFixed(2)}%)`;
                        const color = feed.change >= 0 ? '#4CAF50' : '#F44336';

                        valEl.textContent = valText;
                        chgEl.textContent = chgText;
                        chgEl.style.color = color;
                        if(valElClone) valElClone.textContent = valText;
                        if(chgElClone) { chgElClone.textContent = chgText; chgElClone.style.color = color; }
                    }
                });
            }

            if (data.live) {
                OI_SYMBOLS.forEach(sym => {
                    const liveData = data.live[sym];
                    if (!liveData || !liveData.pulse_summary) return;
                    const lower = sym.toLowerCase();
                    const s = liveData.pulse_summary;

                    const totalOI = s.total_call_oi + s.total_put_oi;
                    const callOIPct = totalOI > 0 ? (s.total_call_oi / totalOI * 100) : 50;
                    document.getElementById(`${lower}-total-call-oi-bar`).style.width = `${callOIPct}%`;
                    document.getElementById(`${lower}-total-put-oi-bar`).style.width = `${100 - callOIPct}%`;
                    document.getElementById(`${lower}-total-call-oi-label`).textContent = s.total_call_oi.toLocaleString();
                    document.getElementById(`${lower}-total-put-oi-label`).textContent = s.total_put_oi.toLocaleString();

                    const totalCOI = Math.abs(s.total_call_coi) + Math.abs(s.total_put_coi);
                    const callCOIPct = totalCOI > 0 ? (Math.abs(s.total_call_coi) / totalCOI * 100) : 50;
                    document.getElementById(`${lower}-total-call-coi-bar`).style.width = `${callCOIPct}%`;
                    document.getElementById(`${lower}-total-put-coi-bar`).style.width = `${100 - callCOIPct}%`;
                    document.getElementById(`${lower}-total-call-coi-label`).textContent = s.total_call_coi.toLocaleString();
                    document.getElementById(`${lower}-total-put-coi-label`).textContent = s.total_put_coi.toLocaleString();
                });

                Object.keys(data.live).forEach(sym => {
                    const lower = sym.toLowerCase();
                    const liveData = data.live[sym];

                    if (liveData.summary) {
                        const summaryCard = document.getElementById(`${sym}_summary`);
                        if (summaryCard) {
                             if(document.getElementById(`${lower}-sp`)) document.getElementById(`${lower}-sp`).textContent = liveData.summary.sp;
                             if(summaryCard.querySelector(`#${lower}-value`)) summaryCard.querySelector(`#${lower}-value`).textContent = liveData.summary.value;
                             if(document.getElementById(`${lower}-call`)) document.getElementById(`${lower}-call`).textContent = liveData.summary.call_oi;
                             if(document.getElementById(`${lower}-put`)) document.getElementById(`${lower}-put`).textContent = liveData.summary.put_oi;
                             if(document.getElementById(`${lower}-pcr`)) document.getElementById(`${lower}-pcr`).textContent = liveData.summary.pcr;
                             if(document.getElementById(`${lower}-sentiment`)) document.getElementById(`${lower}-sentiment`).textContent = liveData.summary.sentiment;
                             if(document.getElementById(`${lower}-add-exit`)) document.getElementById(`${lower}-add-exit`).textContent = liveData.summary.add_exit;
                             if(summaryCard.querySelector(`#${lower}-change`)) summaryCard.querySelector(`#${lower}-change`).textContent = liveData.summary.sp >= 0 ? `+${liveData.summary.sp}` : liveData.summary.sp;
                             if(summaryCard.querySelector(`#${lower}-pct`)) summaryCard.querySelector(`#${lower}-pct`).textContent = liveData.summary.pcr;
                        }
                    }

                    if (OI_SYMBOLS.includes(sym) && liveData.strikes) {
                        const tbody = document.querySelector(`#${lower}-table tbody`);
                        if(tbody) {
                            tbody.innerHTML = '';
                            liveData.strikes.forEach(row => {
                                const tr = document.createElement('tr');
                                if (row.is_atm) tr.classList.add('atm-strike');
                                tr.innerHTML = `
                                    <td class="${getBuildupClass(row.call_buildup)}">${row.call_buildup}</td>
                                    <td>${row.strike}</td>
                                    <td>${row.call_oi.toLocaleString()}</td>
                                    <td style="color: ${row.call_coi > 0 ? '#4CAF50' : '#F44336'}">${row.call_coi.toLocaleString()}</td>
                                    <td class="action-cell">${row.call_action}</td>
                                    <td>${row.put_oi.toLocaleString()}</td>
                                    <td style="color: ${row.put_coi > 0 ? '#4CAF50' : '#F44336'}">${row.put_coi.toLocaleString()}</td>
                                    <td class="action-cell">${row.put_action}</td>
                                    <td class="${getBuildupClass(row.put_buildup)}">${row.put_buildup}</td>`;
                                tbody.appendChild(tr);
                            });
                        }
                    }
                    shared_data_cache[sym] = liveData;
                });

                const activeSymbol = document.querySelector('.tablink.active').dataset.symbol;
                if(data.live[activeSymbol]) {
                    updateCharts(activeSymbol, data.live[activeSymbol]);
                }
            }
        });

        socket.on('equity_data_update', (response) => {
            document.getElementById('equity-loader').classList.add('hidden');
            const dataContainer = document.getElementById('equity-data-container');
            const errorContainer = document.getElementById('equity-error');

            if (response.error) {
                errorContainer.textContent = `Error fetching data for ${response.symbol}: ${response.error}`;
                errorContainer.classList.remove('hidden');
                dataContainer.classList.add('hidden');
                return;
            }

            errorContainer.classList.add('hidden');
            dataContainer.classList.remove('hidden');

            const equityData = response.data;
            const symbol = response.symbol;
            document.getElementById('equity-title').textContent = `${symbol} Option Chain Analysis`;

            const pulseContainer = document.getElementById('equity-market-pulse-container');
            if (!document.getElementById('equity_pulse_card')) {
                const pulseCard = createPulseCard('EQUITY');
                pulseCard.id = 'equity_pulse_card';
                pulseContainer.innerHTML = '';
                pulseContainer.appendChild(pulseCard);
            }
            const pulseSummary = equityData.pulse_summary;
            const totalOI = pulseSummary.total_call_oi + pulseSummary.total_put_oi;
            const callOIPct = totalOI > 0 ? (pulseSummary.total_call_oi / totalOI * 100) : 50;
            document.getElementById('equity-total-call-oi-bar').style.width = `${callOIPct}%`;
            document.getElementById('equity-total-put-oi-bar').style.width = `${100 - callOIPct}%`;
            document.getElementById('equity-total-call-oi-label').textContent = pulseSummary.total_call_oi.toLocaleString();
            document.getElementById('equity-total-put-oi-label').textContent = pulseSummary.total_put_oi.toLocaleString();

            const totalCOI = Math.abs(pulseSummary.total_call_coi) + Math.abs(pulseSummary.total_put_coi);
            const callCOIPct = totalCOI > 0 ? (Math.abs(pulseSummary.total_call_coi) / totalCOI * 100) : 50;
            document.getElementById('equity-total-call-coi-bar').style.width = `${callCOIPct}%`;
            document.getElementById('equity-total-put-coi-bar').style.width = `${100 - callCOIPct}%`;
            document.getElementById('equity-total-call-coi-label').textContent = pulseSummary.total_call_coi.toLocaleString();
            document.getElementById('equity-total-put-coi-label').textContent = pulseSummary.total_put_coi.toLocaleString();

            const summary = equityData.summary;
            document.getElementById('equity-sp').textContent = summary.sp;
            document.getElementById('equity-value').textContent = summary.value.toFixed(2);
            document.getElementById('equity-pcr').textContent = summary.pcr.toFixed(2);
            document.getElementById('equity-intraday-pcr').textContent = summary.intraday_pcr.toFixed(2);
            document.getElementById('equity-sentiment').textContent = summary.sentiment;

            const tableBody = document.querySelector('#equity-table tbody');
            tableBody.innerHTML = '';
            equityData.strikes.forEach(row => {
                const tr = document.createElement('tr');
                if (row.is_atm) tr.classList.add('atm-strike');
                tr.innerHTML = `
                    <td class="${getBuildupClass(row.call_buildup)}">${row.call_buildup}</td>
                    <td>${row.strike}</td>
                    <td>${row.call_oi.toLocaleString()}</td>
                    <td style="color: ${row.call_coi > 0 ? '#4CAF50' : '#F44336'}">${row.call_coi.toLocaleString()}</td>
                    <td class="action-cell">${row.call_action}</td>
                    <td>${row.put_oi.toLocaleString()}</td>
                    <td style="color: ${row.put_coi > 0 ? '#4CAF50' : '#F44336'}">${row.put_coi.toLocaleString()}</td>
                    <td class="action-cell">${row.put_action}</td>
                    <td class="${getBuildupClass(row.put_buildup)}">${row.put_buildup}</td>`;
                tableBody.appendChild(tr);
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('.history-date-picker').forEach(input => input.value = today);

            const pulseContainer = document.getElementById('market-pulse-container');
            OI_SYMBOLS.forEach(sym => {
                pulseContainer.appendChild(createPulseCard(sym));
            });

            document.getElementById("NIFTYOpen").click();

            const equitySelector = $('#equity-symbol-selector');
            equitySelector.select2({
                placeholder: "Select a stock",
                allowClear: true
            });

            fetch('/api/stocks')
                .then(response => response.json())
                .then(stocks => {
                    stocks.forEach(stock => {
                        const option = new Option(stock, stock, false, false);
                        equitySelector.append(option);
                    });
                    equitySelector.trigger('change');
                });

            fetch('/api/bhavcopy')
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched initial Bhavcopy data:", data);
                    updateBhavcopyTables(data);
                });

            document.getElementById('fetch-equity-btn').addEventListener('click', () => {
                const selectedStock = equitySelector.val();
                if (selectedStock) {
                    document.getElementById('equity-data-container').classList.add('hidden');
                    document.getElementById('equity-error').classList.add('hidden');
                    document.getElementById('equity-loader').classList.remove('hidden');
                    socket.emit('fetch_equity_data', { symbol: selectedStock });
                } else {
                    alert("Please select a stock first.");
                }
            });

            document.getElementById('run-bhavcopy-btn').addEventListener('click', () => {
                const statusEl = document.getElementById('bhavcopy-status');
                statusEl.textContent = 'Manual scan triggered... Please wait.';
                statusEl.style.color = '#FFC107';
                socket.emit('run_bhavcopy_manually');
            });
        });
    </script>
</body>
</html>
